<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../bb/lib/browser.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/bb.html#bb.box">bb.box</a></li> -->
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.dialog">bb.dialog</a></li> -->
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.pagelet">bb.pagelet</a></li> -->
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.widget">bb.widget</a></li> -->
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.stateObj">bb.stateObj</a></li> -->
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/bundle.html#bundle.media">bundle.media</a></li> -->
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/control.html#control.distributor">control.distributor</a></li> -->
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.pin">control.pin</a></li> -->
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.room">control.room</a></li> -->
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.remote">control.remote</a></li> -->
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/media.html#media.history">media.history</a></li> -->
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.player">media.player</a></li> -->
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.stream">media.stream</a></li> -->
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.source">media.source</a></li> -->
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/ose.html#ose.data">ose.data</a></li> -->
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.http">ose.http</a></li> -->
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.peer">ose.peer</a></li> -->
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.link">ose.link</a></li> -->
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.logger">ose.logger</a></li> -->
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.plugin">ose.plugin</a></li> -->
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.wrap">ose.wrap</a></li> -->
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/yoctopuce.html">yoctopuce</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/yoctopuce.content.html">yoctopuce.content</a></li>
            
                <li><a href="../classes/yoctopuce.lib.html">yoctopuce.lib</a></li>
            
                <li><a href="../classes/yoctopuce.lib.meteo.html">yoctopuce.lib.meteo</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../bb/lib/browser.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.module(module);

/** Doc {{{1
 * @class bb.lib
 */

// Public {{{1
exports.lastStateObj = null;  // {{{2
/**
 * Last displayed &quot;page bit&quot; key object.
 *
 * @property lastStateObj
 * @type Object
 */

exports.defaultContent = {pagelet: &#x27;dashboard&#x27;};  // {{{2
/**
 * Pagelet displayed by default
 *
 * @property defaultContent
 * @type Object
 */

/**
 * Fired when UI is initialized
 *
 * @event initialized
 */

exports.config = function(name, data) {  // {{{2
/**
 * OSE plugin configuration method.
 *
 * @param name {Object} Configuration name
 * @param data {Object} Configuration data
 *
 * @method config
 */

  Ose.ui = require(&#x27;./index&#x27;);

  this.configData = data;

  $.cookie.json = true;

  Ose.peers.gw.once(&#x27;connected&#x27;, this.run.bind(this));
//  Ose.plugins.on(&#x27;initialized&#x27;, this.run.bind(this));
};

exports.run = function() {  // {{{2
/**
 * Internal OSE UI startup method
 * Emits the &quot;initialized&quot; event
 *
 * @method run
 */

  bindVisibility(this);

  $(window)
    .on(&#x27;popstate&#x27;, onPopstate.bind(this))
    .on(&#x27;resize&#x27;, onResize.bind(this))
    .on(&#x27;unload&#x27;, onUnload.bind(this))
    .on(&#x27;keypress&#x27;, onKeypress.bind(this))
  ;

  this.leftBox = new (M.class(&#x27;./box/left&#x27;))();
  $(&#x27;body&#x27;).append(this.leftBox.html());

  this.contentBox = new (M.class(&#x27;./box/content&#x27;))();
  $(&#x27;body&#x27;).append(this.contentBox.html());

  this.rightBox = new (M.class(&#x27;./box/right&#x27;))();
  this.contentBox.$().append(this.rightBox.html());
  this.rightBox.hide();

  this.leftBox.registerEdgeEvents();
  this.leftBox.addLink(&#x27;Dashboard&#x27;, &#x27;dashboard&#x27;, onTapDashboard.bind(this));
//  this.leftBox.addLink(&#x27;Expand hash&#x27;, &#x27;expandHash&#x27;, expandHash.bind(this));
  this.leftBox.addLink(&#x27;Show URI QR code&#x27;, &#x27;showQRCode&#x27;, showQRCode.bind(this));
//  this.leftBox.addLink(&#x27;Install hosted webapp&#x27;, &#x27;installHostedWebapp&#x27;, installHostedWebapp.bind(this));

  if (this.isMobile()) this.checkOrientation();
  else this.leftBox.width = &#x27;40%&#x27;;

  M.log.notice(&#x27;UI initialized&#x27;);

  var cookie = $.cookie(&#x27;ose&#x27;);
  if (cookie) {
    this.lastHistory = parseInt(cookie.lastHistory) || 0;
  } else {
    this.lastHistory = 0;
  }

  var match = window.location.hash.match(/^#h(\d+)/);
  var last = (match &amp;&amp; parseInt(match[1])) || 0
  if (last &gt; this.lastHistory) {
    this.lastHistory = last;
  }

  var stateObj =
    decodeHash(this, window.location.hash) ||
    cookie &amp;&amp; cookie.stateObj ||
    {content: this.defaultContent};
  ;

  window.history.replaceState(stateObj, &#x27;&#x27;);
  this.display(stateObj, &#x27;init&#x27;);

  $(&#x27;#oseLoading&#x27;).remove();
};

exports.newHistory = function() {  // {{{2
/**
 * Creates a new empty state item to the browser&#x27;s history
 *
 * @method newHistory
 */

  window.history.pushState({}, &#x27;&#x27;, &#x27;#h&#x27; + ++this.lastHistory);

//  console.log(&#x27;NEW HISTORY&#x27;, this.lastHistory);
};

exports.updateHistory = function() {  // {{{2
/**
 * Updates the last history item with the current state object
 *
 * @method updateHistory
 */

  window.history.replaceState(this.getStateObj(), &#x27;&#x27;);

//  console.log(&#x27;UPDATE HISTORY&#x27;, JSON.stringify(window.history.state));
};

exports.display = function(stateObj, source) {  // {{{2
/**
 * Displays or updates ui based on the state object.
 *
 * @param stateObj {Object} State object
 * @param source {String &#x27;user&#x27;|&#x27;history&#x27;} Source of the call
 *
 * @method display
 */

//  console.log(&#x27;NEW StateObj&#x27;, {lastSource: this.lastSource, source: source, expandHash: this.expandHash}, JSON.stringify(stateObj));

  if (! source) source = &#x27;user&#x27;;

  switch (this.lastSource) {
    case &#x27;init&#x27;:
    case &#x27;user&#x27;:
      if (source !== &#x27;history&#x27;) {
        this.updateHistory();
      }
      break;
  }

  if (
    (source === &#x27;user&#x27;) &amp;&amp;
    (! (this.leftBox.visible() || this.contentBox.search.visible()))
  ) {
    this.newHistory();
  }

  this.lastSource = source;

  this.leftBox.hide(true);
  this.contentBox.display(stateObj.content, source);
  this.rightBox.display(stateObj.right, source);

  if (this.dialog/* &amp;&amp; stateObj.dialog*/) {
    this.dialog.$().remove();
    delete this.dialog;
  }

  switch (source) {
    case &#x27;user&#x27;:
      this.updateHistory();

      break;
    case &#x27;history&#x27;:
      if (this.expandHash) {
        window.history.replaceState(stateObj, &#x27;&#x27;, &#x27;#&#x27; + encodeURIComponent(JSON.stringify(stateObj)));
        delete this.expandHash;
      }

      break;
  }

  return;
};

exports.bindContent = function(stateObj) {  // {{{2
/**
 * Creates new event handler that calls the &quot;Ose.ui.display(stateObj)&quot;
 *
 * @param stateObj {Object} State object to be displayed
 *
 * @returns {Function} Event handler calling &quot;Ose.ui.display(stateObj)&quot;
 *
 * @method bindContent
 */

  return function(ev) {
    Ose.ui.display({content: stateObj}, &#x27;user&#x27;);  // ev.ctrlkey

    return false;
  };
};

exports.scrollToTop = function(el) {  // {{{2
/**
 * Scroll element to the top of the screen.
 *
 * @param el {Object} jQuery element to be scrolled to the top
 *
 * @method scrollToTop
 */

  if (! (el instanceof jQuery)) el = $(el);

  $(&#x27;section.content&#x27;).animate({
    scrollTop: el.offset().top + $(&#x27;section.content&#x27;).scrollTop() - $(&#x27;header.fixed&#x27;).height()
  }, 100);
};

exports.handleHover = function(el) {  // {{{2
/**
 * Handle hovering
 *
 * @param el {Object} jQuery element
 *
 * @returns TODO
 *
 * @method handleHover
 */

  return M.log.missing(&#x27;Hover&#x27;);

  if (typeof el === &#x27;string&#x27;) el = $(el);

  el.hover(hover, unhover);

  function hover() {  // {{{3
    $(this).addClass(&#x27;ui-btn-hover-c&#x27;);
  };

  function unhover() {  // {{{3
    $(this).removeClass(&#x27;ui-btn-hover-c&#x27;);
  };

  // }}}3
};

exports.newDialog = function(type, prop) {  // {{{2
/**
 * Creates and displays a new dialog.
 *
 * @param type {String} Dialog type
 * @param prop {Object} Properties object
 *
 * @returns {Object} Dialog instance object
 *
 * @method newDialog
 */

  if (this.dialog) {
    M.log.unhandled(&#x27;Dialog already exist&#x27;);
    return;
  }

  if (type.indexOf(&#x27;/&#x27;) &lt; 0) {
    type = &#x27;./dialog/&#x27; + type;
  }

  this.dialog = new (M.class(type))();
  this.dialog.id = Ose._.uniqueId(&#x27;dlg&#x27;);

  var el = this.dialog.html(prop);
  el.prop(&#x27;id&#x27;, this.dialog.id);
  if (prop &amp;&amp; this.dialog.update) {
    this.dialog.update(el, prop, &#x27;new&#x27;);
  }

  this.newHistory();
  this.updateHistory();

  return this.dialog;
};

exports.closeDialog = function(el) {  // {{{2
/**
 * Closes a dialog
 *
 * @prop el {Object} Dialog jQuery element
 *
 * @method closeDialog
 */

  el.remove();
  delete Ose.ui.dialog;
  history.back();
};

exports.getStateObj = function() {  // {{{2
/**
 * Gets state object
 *
 * @returns {Object} State object
 *
 * @method getStateObj
 */
//  console.log(&#x27;GET STATE OBJ&#x27;, this.rightBox.content);

  var result = {};

  if (this.contentBox.content) {
    result.content = this.contentBox.content.stateObj;
  }

  if (this.rightBox.content &amp;&amp; this.rightBox.content.visible()) {
    result.right = this.rightBox.content.stateObj;
  }

  if (this.dialog) {
    result.dialog = true;
  }

  return result;
};

exports.isMobile = function()  {
/**
 * Tests whether the UI is displayed in a mobile browser
 *
 * @returns {Boolean}
 *
 * @method isMobile
 */

  var mobile = {
    Android: function() {
      return navigator.userAgent.match(/Android/i);
    },
    BlackBerry: function() {
      return navigator.userAgent.match(/BlackBerry/i);
    },
    iOS: function() {
      return navigator.userAgent.match(/iPhone|iPad|iPod/i);
    },
    Opera: function() {
      return navigator.userAgent.match(/Opera Mini/i);
    },
    Windows: function() {
      return navigator.userAgent.match(/IEMobile/i);
    },
    any: function() {
      return (mobile.Android() || mobile.BlackBerry() || mobile.iOS() || mobile.Opera() || mobile.Windows());
    }
  };

  if (mobile.any()) return true;
  else return false;
};

exports.checkOrientation = function() {
/**
 * Checks browser orientation
 *
 * @method checkOrientation
 */

  var that = this;
  var mql = window.matchMedia(&#x27;(orientation: portrait)&#x27;);

  if (mql.matches) {
    this.portrait();
  } else {
    this.landscape();
    this.leftBox.width = window.screen.height * 0.8;
  }

  mql.addListener(function(m) {
    if (m.matches) {
      that.portrait();
    } else {
      that.landscape();
    }
  });
};

exports.portrait = function() {
/**
 * Switch to portrait mode
 *
 * @method portrait
 */

  this.leftBox.width = &#x27;80%&#x27;;
  if (this.leftBox.visible()) this.leftBox.show();
};

exports.landscape = function() {
/**
 * Switch to landscape mode
 *
 * @method landscape
 */

  this.leftBox.width = window.screen.height * 0.8;
  if (this.leftBox.visible()) this.leftBox.show();
};

// }}}1
// Event Handlers {{{1
function onPopstate(ev) {  // {{{2
//  console.log(&#x27;POP STATE&#x27;, window.history.state);

  this.display(window.history.state, &#x27;history&#x27;);
};

function onUnload(ev) {  // {{{2
  this.updateHistory();
//  window.history.replaceState(this.getStateObj(), &#x27;&#x27;);

  $.cookie(
    &#x27;ose&#x27;,
    {
      stateObj: window.history.state,
      lastHistory: this.lastHistory
    },
    {
      expires: 1,
      path: &#x27;/&#x27;
    }
  );
}

function onResize(ev) {  // {{{2
  $(&#x27;.handleResize&#x27;).each(function() {
    $(this).triggerHandler(&#x27;resize&#x27;);
  });
};

function onKeypress(ev) {  // {{{2
  if (this.currentPage &amp;&amp; this.currentPage.bit.mainKeypress) {
    if (this.currentPage.bit.mainKeypress(ev) === false) return false;
    if (ev.isPropagationStopped()) return;
  }

  switch (ev.keyCode || ev.which) {
    case 27: // Escape
      return false;
  }
};

function onTapDashboard(ev) {  // {{{2
  this.display({content: this.defaultContent});

  return false;
};

function expandHash() {  // {{{2
  this.expandHash = true;
  this.leftBox.hide(true);
};

function showQRCode() {  // {{{2
  this.leftBox.hide(true);

  var url = window.location.protocol + &#x27;//&#x27; + window.location.host + window.location.pathname + window.location.search + &#x27;#&#x27; + encodeURIComponent(JSON.stringify(this.getStateObj()));

  var dialog = Ose.ui.newDialog(&#x27;info&#x27;, {
//    caption: &#x27;URL QR Code&#x27;,
    caption: url
  });

  var section = dialog.$(&#x27; section&#x27;);

  section.on(&#x27;click&#x27;, dialog.close.bind(dialog));

  new QRCode(section[0], {
    text: url,
    width: &#x27;200&#x27;,
    height: &#x27;200&#x27;,
    colorDark : &#x27;#000000&#x27;,
    colorLight : &#x27;#ffffff&#x27;,
    correctLevel : QRCode.CorrectLevel.H
  });

  dialog.$(&#x27; img&#x27;).css({
    &#x27;border-style&#x27;: &#x27;solid&#x27;
  });

  section.css({
    &#x27;text-align&#x27;: &#x27;center&#x27;
  });
};

function installHostedWebapp() {
  if (navigator.mozApps &amp;&amp; navigator.mozApps.install) {
    console.log(&#x27;Can install mozApp&#x27;);
    var manifestUri = window.location.protocol + &#x27;//&#x27; + window.location.host + &#x27;/ose-bb/webapp/manifest.webapp&#x27;;
    var req = navigator.mozApps.install(manifestUri);

    req.onsuccess = function(data) {
      console.log(&quot;Success, app installed!&quot;);
      navigator.mozApps.install.triggerChange(&#x27;installed&#x27;);
    };

    req.onerror = function(err) {
      M.log.unhandled(&quot;Webapp  install failed\n\n:&quot; + req.error.name);
    };
  }

  this.leftBox.hide();
}

// }}}1
// Private {{{1
function bindVisibility(that) {
  // Set the name of the hidden property and the change event for visibility
  var hidden, visibilityChange;
  if (typeof document.hidden !== &#x27;undefined&#x27;) { // Opera 12.10 and Firefox 18 and later support
    hidden = &#x27;hidden&#x27;;
    visibilityChange = &#x27;visibilitychange&#x27;;
  } else if (typeof document.mozHidden !== &#x27;undefined&#x27;) {
    hidden = &#x27;mozHidden&#x27;;
    visibilityChange = &#x27;mozvisibilitychange&#x27;;
  } else if (typeof document.msHidden !== &#x27;undefined&#x27;) {
    hidden = &#x27;msHidden&#x27;;
    visibilityChange = &#x27;msvisibilitychange&#x27;;
  } else if (typeof document.webkitHidden !== &#x27;undefined&#x27;) {
    hidden = &#x27;webkitHidden&#x27;;
    visibilityChange = &#x27;webkitvisibilitychange&#x27;;
  }

  if (typeof hidden === &#x27;undefined&#x27;) {
    M.log.unhandled(&#x27;Visibility API is not supported&#x27;);
    return false;
  }

  $(document).on(visibilityChange, function onChange() {
    if (that.visibilityTimeout) {
      clearTimeout(that.visibilityTimeout);
      delete that.visibilityTimeout;
    }

    if (document[hidden]) {
//      console.log(&#x27;DOCUMENT HIDE&#x27;);

      that.visibilityTimeout = setTimeout(function() {  // Wait 10 seconds before peer disconnect.
        delete that.visibilityTimeout;
        Ose.peers.disconnect();
      }, 10000);
    } else {
//      console.log(&#x27;DOCUMENT SHOW&#x27;);

      Ose.peers.connect();
    }
  });

  return true;
};

function decodeHash(that, hash) {  // {{{2
  // returns object containing key for content eventualy other pagelets or null.

//  console.log(&#x27;DECODE HASH&#x27;, hash);

  switch (typeof hash) {
    case &#x27;undefined&#x27;:
      return null;
    case &#x27;object&#x27;:
      return hash;
    case &#x27;string&#x27;:
      var match = hash.match(/^#h(\d+)/);

      if (match) {  // Hash is history item.
        return null;
      }

      if (hash.charAt(0) === &#x27;#&#x27;) hash = hash.substr(1);

      if (! hash) {
        return null;
      }

      try {
        return JSON.parse(hash);
      } catch (error) {
        return JSON.parse(decodeURIComponent(hash));
      }
  }

  return null;
};

// }}}1
/* COMMENTS {{{1
function onDragend(data, ev) {  // {{{2
  $(&#x27;body&#x27;)
    .removeClass(&#x27;unselectable&#x27;)
    .off(&#x27;panmove&#x27;, data.dragHandle)
    .off(&#x27;panend&#x27;, data.dragendHandle)
  ;

  delete this.dragging;

  data.end &amp;&amp; data.end(ev, data);

  return false;
};

exports.startDrag = function(data) {  // {{{2
  if (this.dragging) {
    return null;
  }

  if (typeof data === &#x27;function&#x27;) {
    data = {drag: data};
  }

  this.dragging = data;

  $(&#x27;body&#x27;)
    .addClass(&#x27;unselectable&#x27;)
    .on(&#x27;panend&#x27;, data.dragendHandle = onDragend.bind(this, data))
  ;

  if (data.drag) {
//    $(&#x27;body&#x27;).on(&#x27;drag&#x27;, data.dragHandle = Ose._.throttle(data.drag, 5));
//    $(&#x27;body&#x27;).on(&#x27;drag&#x27;, data.dragHandle = Ose._.throttle(data.drag, 25));
    $(&#x27;body&#x27;).on(&#x27;panmove&#x27;, data.dragHandle = data.drag);
  }

  return data;
};

// }}}1 */

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <!--script src="../assets/js/tabs.js"></script-->
  <script src="../assets/js/ose.js"></script>
</body>
</html>
