<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../control/lib/light/index.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <li><a href="../modules/bundle.lirc.html">bundle.lirc</a></li>
                        
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                            <li><a href="../modules/bundle.rpi.html">bundle.rpi</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/yoctopuce.html">yoctopuce</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.lirc.html">bundle.example.lirc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.example.rpi.html">bundle.example.rpi</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.config.html">bundle.examples.lirc.config</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.lirc.html">bundle.examples.lirc.lirc</a></li>
            
                <li><a href="../classes/bundle.examples.media.channels.html">bundle.examples.media.channels</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.examples.media.streams.html">bundle.examples.media.streams</a></li>
            
                <li><a href="../classes/bundle.examples.rpi.config.html">bundle.examples.rpi.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.remote.html">media.lib.player.remote</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/yoctopuce.content.html">yoctopuce.content</a></li>
            
                <li><a href="../classes/yoctopuce.lib.html">yoctopuce.lib</a></li>
            
                <li><a href="../classes/yoctopuce.lib.meteo.html">yoctopuce.lib.meteo</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../control/lib/light/index.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.singleton(module, &#x27;ose/lib/kind&#x27;);
exports = M.exports;

var Pin = M.class(&#x27;./pin&#x27;);
var Switch = M.class(&#x27;./switch&#x27;);

/** Doc {{{1
 * @submodule control.room
 */

/**
 * @caption Light kind
 *
 * @readme
 * [Entry kind] defining behaviour of lights. Each light consists of
 * channels. Each channel is controlled by some &#x60;master&#x60;
 * controller. It is possible to use dimming when the controller
 * supports it. This component allows to easily create lights composed
 * of LED strips that can smoothly change the colour and intensity,
 * and do any other effects.
 *
 * Smooth changes of light intensity can be controlled through the
 * &#x60;speed&#x60; value, which defines the time in milliseconds it takes
 * change the light intensity from 0 to 100% or vice versa.
 *
 * Each light supports auto-off timeout since last change with
 * configurable dim speed.
 *
 * Every light can be controlled by a [switch entry] with the
 * following behaviour:
 * - One tap when shining: Switch the light off.
 * - One tap when off: Switch to the default configurable value.
 * - Two taps: Switch the light fully on.
 * - Hold: Switch the light off.
 *
 * @aliases light lights lightEntry
 * @class control.lib.light
 * @extend ose.lib.kind
 * @type class
 */

/**
 * Light channels
 *
 * A light entry can consist of one or more channels. An example light
 * can have 3 LED strips (warm white, cold white and RGB). The entry
 * describing such a light consists of 5 independently controllable
 * channels (warm, cold, red, green and blue).
 *
 * Each property of &#x60;data.channels&#x60; is one channel. The key is a
 * channel name and the value is the pin index on the &#x60;data.master&#x60;
 * controller.
 *
 * @example
 *     data.channels = {
 *       warm: 0,
 *       cold: 1,
 *       red: 2,
 *       green: 3,
 *       blue: 4
 *     }
 *
 * @property data.channels
 * @type Object
 */

/**
 * Controller entry identification object.
 *
 * The light entry establishes a new link to the controller.
 *
 * @property data.master
 * @type String | Object
 */

/**
 * Each property of this object defines one profile of the
 * light. There are predefined profiles &#x60;&quot;off&quot;&#x60;, &#x60;&quot;on&quot;&#x60; and &#x60;&quot;full&quot;&#x60;.
 *
 * Default values are:
 * - &#x60;&quot;off&quot;: 0&#x60;
 * - &#x60;&quot;on&quot;: M.consts.lightDefaultOn&#x60;
 * - &#x60;&quot;full&quot;: 1&#x60;
 *
 * @property data.main
 * @type Object
 */

/**
 * Switch entry identification object.
 *
 * If specified, the light establishes a new link to a switch and gets
 * controlled by it.
 *
 * @property data.switch
 * @type String | Object
 */

/**
 * Auto off value
 *
 * Defines how long the light will wait before it starts dimming and
 * the speed of the dimming. The auto off timer is enabled each time
 * any light channel is changed.
 *
 * The value can be one of the following:
 * - &#x60;true&#x60;: Enable auto off with default values
 * - &#x60;false&#x60;: Disable auto off
 * - Number: Wait timeout in seconds
 * - Object: &#x60;{wait: &lt;seconds&gt;, speed: &lt;milliseconds&gt;}&#x60;
 *
 * Default values:
 * - &#x60;data.autoOff.wait: M.consts.lightAutoOffWait&#x60;
 * - &#x60;data.autoOff.speed: M.consts.lightAutoOffSpeed&#x60;
 *
 * @property data.autoOff
 * @type Boolean | Number | Object
 */

// Public  {{{1
exports.init = function() {  // {{{2
  this.on(&#x27;set&#x27;, set);
  this.on(&#x27;lock&#x27;, lock);
  this.on(&#x27;stop&#x27;, stop);
  this.on(&#x27;delta&#x27;, delta);
  this.on(&#x27;switch&#x27;, switch_);
  this.on(&#x27;update&#x27;, update);
  this.on(&#x27;profile&#x27;, profile);
  this.on(&#x27;autoOff&#x27;, autoOff);
};

exports.inView = function(entry, params) {  // {{{2
  if (params.filter) {
    if (&#x27;turned&#x27; in params.filter) {
      return params.filter.turned === entry.state.main;
    }
  }

  return true;
};

exports.homeInit = function(entry) {  // {{{2
  entry.on(&#x27;state&#x27;, onState.bind(entry));

  entry.queueStateTimeout = 1;

  entry.channels = {};

  entry.state = {
    main: &#x27;off&#x27;,
    channels: {}
  };

  if (entry.data) {
    if (entry.data.channels) {
      if (entry.data.pin) {
        M.log.warning(&#x27;Ignoring pin!&#x27;, {entry: entry.identify(), pin: entry.data.pin});
      }

      for (var key in entry.data.channels) {
        new Pin(
          entry,
          key,
          entry.data.channels[key]
        );
      }
    } else if (entry.data.pin) {
      new Pin(entry, &#x27;single&#x27;, entry.data.pin);
    }

    if (entry.data.switch) {
      // Creates a &#x60;slave&#x60; socket
      if (Array.isArray(entry.data.switch)) {
        for (var i = 0; i &lt; entry.data.switch.length; i++) {
          new Switch(entry, entry.data.switch[i]);
        }
      } else {
        new Switch(entry, entry.data.switch);
      }
    }
  }

//  console.log(&#x27;LIGHT HARBOUR INITED&#x27;, entry.id, entry.state);
};

// }}}1
// Commands {{{1
function profile(req, socket) {  // {{{2
/**
 * [Command handler].
 *
 * Sets light profile.
 *
 * @param req {Object|String} Sets the light to the value specified. Simple profile name can be specified.
 * @param req.name {String} Profile name
 * @param [req.speed] {Number} Speed of change
 *
 * @method profile
 */

//  console.log(&#x27;LIGHT TURN&#x27;, req);

  if (testLock(this, socket)) return;

  if (typeof req !== &#x27;object&#x27;) {
    req = {name: req};
  }

  setProfile(
    this.entry,
    req.name,
    req.speed,
    socket
  );
};

function switch_(req, socket) {  // {{{2
/**
 * [Command handler].
 *
 * Switch between on or off profiles.
 *
 * @param req {Object} Sets the light to the value specified. If &#x60;req&#x60; is not an object &#x60;req&#x60; is replaced with &#x60;{type: req, speed: M.consts.lightDimSpeed}&#x60;
 * @param req.type {Null | Boolean | Number, String}
 * - &#x60;false&#x60;: Switch all channels off
 * - &#x60;true&#x60;: Switch all channels to profile &quot;on&quot;
 * - &#x60;&quot;off&quot;&#x60;: Switch all channels off
 * - &#x60;&quot;on&quot;&#x60;: Switch all channels to profile &quot;on&quot;
 * @param [req.speed] {Number} Speed of change
 *
 * @method switch
 */

//  console.log(&#x27;LIGHT SWITCH&#x27;, req);

  if (testLock(this, socket)) return;

  var e = this.entry;

  if (typeof req !== &#x27;object&#x27;) {
    req = {name: req};
  }

  switch (req.name) {
  case 1:
  case true:
  case &#x27;on&#x27;:
    profile(&#x27;on&#x27;);
    return;
  case 0:
  case false:
  case &#x27;off&#x27;:
    profile(&#x27;off&#x27;);
    return;
  case &#x27;switch&#x27;:
  case null:
  case undefined:
    if (almostOff(e)) {
      profile(&#x27;on&#x27;);
    } else {
      profile(&#x27;off&#x27;);
    }
    return;
  }

  Ose.link.error(socket, Ose.error(this.entry, &#x27;INVALID_ARGS&#x27;, req));
  return;

  function profile(name) {
    setProfile(e, name, req.speed, socket);
  }
};

function set(req, socket) {  // {{{2
/**
 * [Command handler].
 *
 * Sets all channels.
 *
 * @param req {Number | Object} Sets the light to the value specified. &#x60;req&#x60; can be one of the following:
 * - Number: Switch all channels to this value. It should be number between 0 .. 1
 * - Object: Sets channels to requested value. Channels not listed will be switched off
 *
 * @param socket {Object} Response [socket]
 *
 * @method set
 */

//  console.log(&#x27;LIGHT SET&#x27;, req);

  if (testLock(this, socket)) return;

  var e = this.entry;

  switch (typeof req) {
  case &#x27;object&#x27;:
    break;
  case &#x27;number&#x27;:
    if ((req &gt;= 0) &amp;&amp; (req &lt;= 1)) break;
  default:
    Ose.link.error(socket, Ose.error(e, &#x27;INVALID_REQ&#x27;, req));
    return;
  }

  switch (typeof req) {
  case &#x27;number&#x27;:
    for (var key in e.channels) {
      e.channels[key].link.update({
        value: req,
        speed: M.consts.lightDimSpeed,
      });
    }
    Ose.link.close(socket);
    return;
  case &#x27;object&#x27;:
    for (var key in e.channels) {
      var a = {
        index: e.state.channels[key].pin,
        speed: M.consts.lightDimSpeed,
      };

      if (key in req) {
        a.value = req[key];
      } else {
        a.value = 0;
      }

      e.channels[key].link.update(a);
    }
    Ose.link.close(socket);
    return;
  }

  Ose.link.error(socket, Ose.error(e, &#x27;INVALID_ARGS&#x27;, req));
  return;
};

function stop(req, socket) {  // {{{2
/**
 * [Command handler].
 *
 * Keep all channels at their current value.
 *
 * @param [req] {*} Unused
 * @param socket {Object} Response [socket]
 *
 * @method set
 */

//  console.log(&#x27;LIGHT SET&#x27;, req);

  if (testLock(this, socket)) return;

  var e = this.entry;

  for (var key in e.channels) {
    e.channels[key].link.update({
      value: &#x27;stop&#x27;,
    });
  }

  Ose.link.close(socket);
};

function delta(req, socket) {  // {{{2
/**
 * [Command handler]
 *
 * Update requested channels.
 *
 * @param req {String | Number} Delta
 * @param socket {Object} Response [socket]
 *
 * @method delta
 */

//  console.log(&#x27;LIGHT DELTA&#x27;, req, this.entry.state);

  if (testLock(this, socket)) return;

  var e = this.entry;

  if (typeof req !== &#x27;object&#x27;) {
    req = {value: req};
  }

  if (! (&#x27;speed&#x27; in req)) {
    req.speed = M.consts.lightDimSpeed;
  }

  switch (req.value) {
  case &#x27;more&#x27;:
    req.value = 0.05;
    break;
  case &#x27;less&#x27;:
    req.value = -0.05;
    break;
  }

  if ((typeof req.value !== &#x27;number&#x27;) || isNaN(req.value)) {
    Ose.link.error(socket, Ose.error(e, &#x27;INVALID_ARGS&#x27;, req));
    return;
  }

  if (almostOff(e)) {
    if (req.value &lt; 0) {
      Ose.link.close(socket);
      return;
    }

    switch (typeof (e.data.main &amp;&amp; e.data.main.on || 0)) {
    case &#x27;number&#x27;:
      for (var key in e.channels) {
        e.channels[key].link.update({
          value: e.state.channels[key].value + req.value,
          speed: req.speed,
        });
      }
      return;
    case &#x27;object&#x27;:
      for (var key in e.data.main.on) {
        e.channels[key].link.update({
          value: e.state.channels[key].value + req.value,
          speed: req.speed,
        });
      }
      return;
    }

    throw Ose.error(e, &#x27;INVALID&#x27;, &#x27;Invalid main on&#x27;, e.data.main.on);
  }

  var now = Ose._.now();
  for (var key in e.channels) {
    var c = e.state.channels[key];
    var v = c.value;

    if (&#x27;aim&#x27; in c) {
      if (c.aim === null) {
        M.log.error(Ose.error(e, &#x27;NOT_EXPECTED&#x27;, &#x27;State should never be null!&#x27;, JSON.stringify({channel: key, state: e.state}, null, 2)));
      } else {
        v = c.value + (c.aim - c.value) * ((now - c.at) / c.time);
      }
    }

    if (v) {
      v += req.value;
      if (v &gt; 1) {
        v = 1;
      } else if (v &lt; 0) {
        v = 0;
      }
      e.channels[key].link.update({
        value: v,
        speed: req.speed,
      });
    }
  }
  return;
};

function update(req, socket) {  // {{{2
/**
 * [Command handler]
 *
 * Update requested channels.
 *
 * @param req {Number|Object} List of channels with their requested values.
 * @param socket {Object} Response [socket]
 *
 * @method update
 */

  if (testLock(this, socket)) return;

  var e = this.entry;

//  console.log(&#x27;LIGHT UPDATE&#x27;, req, e.state);

  switch (typeof req) {
  case &#x27;number&#x27;:
    switch (typeof (e.data.main &amp;&amp; e.data.main.on || 0)) {
    case &#x27;number&#x27;:
      for (var key in e.channels) {
        e.channels[key].link.update({
          value: req,
          speed: 5000,
        });
      }
      return;
    case &#x27;object&#x27;:
      for (var key in e.data.main.on) {
        e.channels[key].link.update({
          value: req,
          speed: 5000,
        });
      }
      return;
    }

    Ose.link.error(socket, Ose.error(e, &#x27;INVALID_ARGS&#x27;, &#x27;Invalid profile &quot;on&quot;!&#x27;, e.data.main));
    return;
  case &#x27;object&#x27;:
    for (var key in req) {
      if (! (key in e.channels)) {
        Ose.link.error(socket, Ose.error(e, &#x27;INVALID_ARGS&#x27;, &#x27;Invalid channel!&#x27;, {request: req, channel: key}));
        return;
      }

      var a = req[key];
      var c = e.channels[key];

      if (typeof a === &#x27;object&#x27;) {
        c.link.update({
          value: a.value,
          speed: a.speed,
        });
      } else {
        c.link.update({value: a});
      }
    }
    return;
  }

  Ose.link.error(socket, Ose.error(e, &#x27;INVALID_ARGS&#x27;, req));
  return;
};

function lock(req, socket) {  // {{{2
/**
 * [Command handler].
 *
 * Lock or unlock a light. Locked light cannot be changed via its command handlers.
 *
 * @param [req] {Boolean} Unused
 * @param socket {Object} Response [socket]
 *
 * @method lock
 */

  var e = this.entry;

  if (typeof req !== &#x27;boolean&#x27;) {
    Ose.link.error(socket, Ose.error(e, &#x27;INVALID_ARGS&#x27;, &#x27;Request should be boolean!&#x27;));
    return;
  }

  if (req) {
    e.setState({locked: true});
    clearOff(e);
  } else {
    e.setState({locked: null});
    setupOff(e);
  }

  Ose.link.close(socket);
};

function autoOff(req, socket) {  // {{{2
/**
 * [Command handler]
 *
 * Change auto off behaviour.
 *
 * @param req {Boolean | Number | Object} Auto off configuration conforming to [data.autoOff].
 * @param socket {Object} Response [socket]
 *
 * @method autoOff
 */

  if (testLock(this, socket)) return;

  switch (req) {
  case undefined:
  case null:
  case false:
  case 0:
    clearOff(this.entry);
    break;
  case true:
    setupOff(this.entry);
    break;
  default:
    setupOff(this.entry, req);
    break;
  }

  Ose.link.close(socket);
};

// }}}1
// Event handlers {{{1
function onState(data) {  // {{{2
  if (! (&#x27;channels&#x27; in data)) return;

  var main = &#x27;off&#x27;;

  for (var key in this.channels) {
    var c = this.state.channels[key];
    if (! c) continue;

    if (c.aim === 0) {
      main = &#x27;dim&#x27;;
    } else if ((c.value &gt; 0) || (c.aim &gt; 0)) {
      main = &#x27;on&#x27;;
      break;
    }
  }

  this.setState({main: main});

  switch (main) {
  case &#x27;off&#x27;:
  case &#x27;dim&#x27;:
    clearOff(this);
    return;
  case &#x27;on&#x27;:
    setupOff(this);
    return;
  }

  throw Ose.error(this, &#x27;invalidMain&#x27;, main);
};

// }}}1
// Private {{{1
function setProfile(entry, name, speed, socket) {  // {{{2
  var p = entry.data.main &amp;&amp; entry.data.main[name];
  if (p === undefined) {
    switch (name) {
    case &#x27;off&#x27;:
      p = 0;
      break;
    case &#x27;on&#x27;:
      p = 0.2;
      break;
    case &#x27;full&#x27;:
      p = 1;
      break;
    }
  }

  switch (typeof p) {
  case &#x27;number&#x27;:
    for (var key in entry.channels) {
      entry.channels[key].link.update({
        value: p,
        speed: sp(),
      });
    }
    Ose.link.close(socket);
    return;
  case &#x27;object&#x27;:
    for (var key in entry.channels) {
      if (key in p) {
        var c = p[key];
        if (typeof c !== &#x27;object&#x27;) {
          c = {value: c};
        }

        entry.channels[key].link.update({
          value: c.value,
          speed: sp(c.speed),
        });
      } else {
        entry.channels[key].link.update({
          value: 0,
          speed: sp(),
        });
      }
    }
    Ose.link.close(socket);
    return;
  }

  Ose.link.error(socket, Ose.error(entry, &#x27;INVALID_ARGS&#x27;, &#x27;Invalid profile!&#x27;, name));
  return;

  function sp(val) {
    if (typeof val === &#x27;number&#x27;) {
      return val;
    }

    if (typeof speed === &#x27;number&#x27;) {
      return speed;
    }

    return M.consts.lightDimSpeed;
  }
};

function almostOff(entry) {  // {{{2
  switch (entry.state.main) {
  case &#x27;on&#x27;:
    return false;
  case &#x27;off&#x27;:
    return true;
  case &#x27;dim&#x27;:
    var now = Ose._.now();
    for (var key in entry.state.channels) {
      var c = entry.state.channels[key];

      if ((c.aim === 0) &amp;&amp; ((c.at + c.time - now) &gt; 20000)) {
        return false;
      }
    }

    return true;
  }

  throw Ose.error(entry, &#x27;INVALID&#x27;, &#x27;Invalid main&#x27;, entry.state.main);
};

function clearOff(entry) {  // {{{2
//  console.log(&#x27;CLEAR OFF TIMEOUT&#x27;);

  if (entry.offTimeout) {
    clearTimeout(entry.offTimeout);
    delete entry.offTimeout;

    entry.setState({autoOff: null});
  }
};

function setupOff(entry, data) {  // {{{2
  clearOff(entry);

//  console.log(&#x27;SETUP OFF TIMEOUT&#x27;, data);

  var wait;
  var speed;

  if (! data) {
    data = entry.data.autoOff;
    if (! data) {
      return;
    }
  }

  switch (typeof data) {
  case &#x27;number&#x27;:
    wait = data * 1000;
    speed = M.consts.lightAutoOffSpeed;
    break;
  case &#x27;boolean&#x27;:
    wait = M.consts.lightAutoOffWait;
    speed = M.consts.lightAutoOffSpeed;
    break;
  case &#x27;object&#x27;:
    wait = data.wait * 1000;
    speed = data.speed;
    break;
  default:
    M.log.error(Ose.error(this, &#x27;invalidAutoOff&#x27;, data));
    return;
  }

  entry.offTimeout = setTimeout(onTime, wait);
  entry.setState({autoOff: {
    start: new Date().getTime(),
    wait: wait,
    speed: speed,
  }});

  return;

  function onTime() {  // {{{3
//    console.log(&#x27;LIGHT AUTOOFF&#x27;, speed);

    delete entry.offTimeout;

    for (var key in entry.channels) {
      var c = entry.state.channels[key];
      if (c &amp;&amp; (c.value || c.time)) {
        entry.channels[key].link.update({
          value: 0,
          speed: speed,
        });
      }
    }
  };

  // }}}3
};

function testLock(src, socket) {  // {{{ 2
  if (src.entry.state.locked) {
    Ose.link.close(socket, &#x27;locked&#x27;);
    return true;
  }

  return false;
};

// }}}1

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <script src="../assets/js/ose.js"></script>
</body>
</html>
