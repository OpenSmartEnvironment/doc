<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../ose/lib/http/index.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <li><a href="../modules/bundle.lirc.html">bundle.lirc</a></li>
                        
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                            <li><a href="../modules/bundle.rpi.html">bundle.rpi</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/yoctopuce.html">yoctopuce</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.lirc.html">bundle.example.lirc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.example.rpi.html">bundle.example.rpi</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.config.html">bundle.examples.lirc.config</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.lirc.html">bundle.examples.lirc.lirc</a></li>
            
                <li><a href="../classes/bundle.examples.media.channels.html">bundle.examples.media.channels</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.examples.media.streams.html">bundle.examples.media.streams</a></li>
            
                <li><a href="../classes/bundle.examples.rpi.config.html">bundle.examples.rpi.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.remote.html">media.lib.player.remote</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/yoctopuce.content.html">yoctopuce.content</a></li>
            
                <li><a href="../classes/yoctopuce.lib.html">yoctopuce.lib</a></li>
            
                <li><a href="../classes/yoctopuce.lib.meteo.html">yoctopuce.lib.meteo</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../ose/lib/http/index.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.module(module);
Ose.http = exports;

var Url = require(&#x27;url&#x27;);
var Fs = require(&#x27;fs&#x27;);
var Path = require(&#x27;path&#x27;);

/** Docs {{{1
 * @caption HTTP server
 *
 * @readme
 * This component provides an HTTP server for OSE. It responds to HTTP
 * requests and provides data needed to run OSE instance in the
 * browser. Each OSE package that needs to run in the browser creates
 * one &#x60;ose/lib/http/content&#x60; class instance and defines which files
 * will be provided to the browser.
 *
 * It also handles incoming WebSocket requests from other OSE
 * instances and relays them to the [peers component].
 *
 * @module ose
 * @submodule ose.http
 * @main ose.http
 */

/**
 * @caption HTTP server plugin
 *
 * @readme
 * This singleton provides HTTP server for OSE instance.
 *
 * @class ose.lib.http
 * @type module
 */

/**
 * IP address of Node.js host
 *
 * @property ip
 * @type String
 */

/**
 * Port of Node.js HTTP server
 *
 * @property port
 * @type Number
 */

/**
 * List of files
 *
 * @property files
 * @type Object
 */

/**
 * List of content objects
 *
 * @property contents {Object}
 */

// Public {{{1
exports.files = [];  // Files in index, ordered.
exports.contents = {};  // contents registered to this http server.

exports.config = function(key, data) {  // {{{2
/**
 * [OSE plugin] configuration method
 *
 * @param data {Object} Configuration data object
 *
 * @method config
 */

//  console.log(&#x27;data HTTP&#x27;, data);

  this.ip = data.ip;
  this.port = data.port || 8124;

  this.cache = data.cache;

  Ose.plugins.addDependency(dependencyConfig.bind(this, data));
  Ose.plugins.once(&#x27;initialized&#x27;, sortFiles.bind(this));
};

exports.addContent = function(content) {  // {{{2
/**
 * Adds content instance
 *
 * @param content {Object}
 *
 * @method addContent
 */

//  console.log(&#x27;ADDING CONTENT&#x27;, content.name);

  if (this.contents[content.name]) {
    M.log.unhandled(&#x27;content already exist&#x27;, content.name);
  } else {
    this.contents[content.name] = content;
  }
};

exports.addHead = function(uri, order, remote) {  // {{{2
/**
 * TODO
 *
 * @param uri {String} URI
 * @param order {Number} Order in which to provide file
 * @param remote {} TODO
 *
 * @method addHead
 */

  var pos = uri.lastIndexOf(&#x27;.&#x27;);
  if (pos) {
    var ext = uri.substr(pos);
    uri = uri.substr(0, pos);
  } else {
    var ext = &#x27;&#x27;;
  }

  this.files.push({
    uri: uri,
    ext: ext,
    order: order,
    remote: remote
  });
}

exports.getUrl = function() {  // {{{2
/**
 * Returns url of this Http instance.
 *
 * @return {String} URL of Http instance
 *
 * @method getUrl
 */

  return (Ose.ssl ? &#x27;https&#x27; : &#x27;http&#x27;) + &#x27;://&#x27; +
    this.ip + &#x27;:&#x27; +
    this.port
  ;
}

// }}}1
// Event Handlers {{{1
function dependencyConfig(config, cb) {  // {{{2
  var that = this;

  if (Ose.ssl) {
    Ose.readSsl(onSsl);
  } else {
    this.http = require(&#x27;http&#x27;).createServer();
    bindHttp();
  }

  function onSsl(err, data) {  // {{{3
    if (err) {
      cb(err);
      return;
    }

    var options = {
      key: data.key,
      cert: data.cert
    };

    that.http = require(&#x27;https&#x27;).createServer(options);

    bindHttp();

    return;
  };

  function bindHttp() {  // {{{3
    that.http.on(&#x27;error&#x27;, onError);
    that.http.on(&#x27;request&#x27;, onRequest.bind(that));
    that.http.listen(that.port, that.ip, httpDone);
  }

  function httpDone() {  // {{{3
    M.log.notice((Ose.ssl ? &#x27;HTTPs&#x27; : &#x27;HTTP&#x27;) + &#x27; server started.&#x27;, {ip: that.ip || &#x27;all&#x27;, port: that.port});

    that.ws = new (require(&#x27;ws&#x27;).Server)({
      server: that.http,
      verifyClient: Ose.peers.onVerify
    });
    that.ws.on(&#x27;connection&#x27;, Ose.peers.onConnect);
    that.ws.on(&#x27;error&#x27;, onError);

    M.log.notice(&#x27;WebSockets server started.&#x27;);

    cb();  // TODO What if &quot;httpDone&quot; is not invoked.
  }

  // }}}3
};

function sortFiles() {  // {{{2
  this.files.sort(function(a, b) {
    return a.order - b.order;
  });
}

function onRequest(req, resp) {  // {{{2
  var url = Url.parse(req.url, true);

  switch (url.pathname) {
    case &#x27;&#x27;:
    case &#x27;/&#x27;:
    case &#x27;/index&#x27;:
    case &#x27;/index.html&#x27;:
      return respondIndex(this, req, resp);
    case &#x27;/apple-touch-icon.png&#x27;:
    case &#x27;/apple-touch-icon-precomposed.png&#x27;:
    case &#x27;/favicon.ico&#x27;:
      return respondFavicon(this, req, resp);
  }

  var path = url.pathname.split(Path.sep);
  if (! path[0]) path.shift();

  var content = this.contents[path[0]];
  if (content) {
    path.shift();
    path = path.join(&#x27;/&#x27;);

    var pos = path.lastIndexOf(&#x27;.&#x27;);
    if (pos) {
      var ext = path.substr(pos);
      path = path.substr(0, pos);
    } else {
      var ext = &#x27;&#x27;;
    }

    return content.respond(req, resp, path, ext, {cache: this.cache});
  };

  resp.statusCode = 404;
  resp.end();

  M.log.unhandled(&#x27;HTTP file not found!&#x27;, url.pathname);

  return;
};

function onError() {  // {{{2
  M.log.unhandled(&#x27;HTTP error&#x27;, arguments);
};

// }}}1
// Private {{{1
function respondIndex(that, req, resp) {  // {{{2
  resp.writeHead(200, {&#x27;Content-Type&#x27;: &#x27;text/html&#x27;});

  resp.write(&#x27;&lt;!DOCTYPE html&gt;&#x27;);
  // TODO: Make html5 offline cache work.
  //  resp.write(&#x27;&lt;html manifest=&quot;./ose-bb/offline.appcache&quot;&gt;&lt;head&gt;&#x27;);
  resp.write(&#x27;&lt;html&gt;&lt;head&gt;&#x27;);
  resp.write(&#x27;  &lt;meta charset=&quot;utf-8&quot;&gt;&#x27;);
  resp.write(&#x27;  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, user-scalable=0, initial-scale=1, maximum-scale=1&quot;&gt;&#x27;);
  resp.write(&#x27;  &lt;title&gt;Personal Environment&lt;/title&gt;&#x27;);

  for (var i = 0; i &lt; that.files.length; i++) {
    file(that.files[i]);
  }

  for (var key in that.contents) {
    that.contents[key].printIndex(req, resp);
  }

  resp.write(&#x27;  &lt;script src=&quot;ose/config.js&quot;&gt;&lt;/script&gt;&#x27;);
  resp.write(&#x27;&lt;/head&gt;&lt;body&gt;&#x27;);

  resp.write(&#x27;&lt;div id=&quot;oseLoading&quot;&gt;&#x27;);
  resp.write(&#x27;  &lt;p&gt;Loading Open Smart Environment&lt;/p&gt;&#x27;);
  resp.write(&#x27;&lt;/div&gt;&#x27;);

  resp.write(&#x27;&lt;script&gt;&#x27;);
  resp.write(&#x27;  &quot;use strict&quot;;&#x27;);
//  resp.write(&#x27;  $(document).ready(function() {window.ose.run(&#x27; + JSON.stringify(Ose.plugins.browserConfig()) + &#x27;);});&#x27;);
  resp.write(&#x27;  $(document).ready(function() {window.ose.run();});&#x27;);
  resp.write(&#x27;&lt;/script&gt;&#x27;);

  resp.end(&#x27;&lt;/body&gt;&lt;/html&gt;&#x27;);

  function file(data) {
    switch (data.ext) {
      case &#x27;.css&#x27;:
        resp.write(&#x27;  &lt;link rel=&quot;stylesheet&quot; href=&quot;&#x27; + data.uri + &#x27;.css&quot; /&gt;&#x27;);
        break;
      case &#x27;.js&#x27;:
        resp.write(&#x27;  &lt;script src=&quot;&#x27; + data.uri + &#x27;.js&quot;&gt;&lt;/script&gt;&#x27;);
        break;
    }
  }
};

function respondFavicon(that, req, resp) {  // {{{2
  resp.end();
};

// }}}1

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <script src="../assets/js/ose.js"></script>
</body>
</html>
