<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../ose/lib/link.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/bb.html#bb.box">bb.box</a></li> -->
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.dialog">bb.dialog</a></li> -->
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.pagelet">bb.pagelet</a></li> -->
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.widget">bb.widget</a></li> -->
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.stateObj">bb.stateObj</a></li> -->
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/bundle.html#bundle.media">bundle.media</a></li> -->
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/control.html#control.distributor">control.distributor</a></li> -->
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.pin">control.pin</a></li> -->
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.room">control.room</a></li> -->
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.remote">control.remote</a></li> -->
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/media.html#media.history">media.history</a></li> -->
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.player">media.player</a></li> -->
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.stream">media.stream</a></li> -->
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.source">media.source</a></li> -->
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/ose.html#ose.data">ose.data</a></li> -->
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.http">ose.http</a></li> -->
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.peer">ose.peer</a></li> -->
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.link">ose.link</a></li> -->
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.logger">ose.logger</a></li> -->
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.plugin">ose.plugin</a></li> -->
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.wrap">ose.wrap</a></li> -->
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../ose/lib/link.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.module(module);

/** Doc {{{1
 * @caption Sockets and links
 *
 * @readme
 * The framework makes it possible to easily create links between
 * &#x60;entries&#x60; to allow communication regardless of whether it is
 * realized within one OSE instance or transparently across multiple
 * OSE instances. A link is a virtual bidirectional communication
 * channel between two sockets. Link cannot exist without an active
 * [peer-to-peer] connection channel between sockets. When some
 * WebSocket channel is closed, an &#x60;error&#x60; handler is called on both
 * ends of links using such channel and links are closed.
 *
 * Each socket is an object with handlers. A socket is either a client
 * socket or a response socket. To establish a link, a client socket
 * must first be created. The client socket must then be delivered to
 * the master entry&#x27;s handler. This handler must then create a
 * corresponding response socket and open a link.  After the link is
 * established, the client and response sides become equal.
 *
 *
 * @description

 * ## Example

 * Below is a real example of how a link is created and works between
 * the [light entry] and the [switch entry]. The [light entry] has a
 * controlling [switch entry] identification assigned in its
 * &#x60;entry.data.switch&#x60; value. Based on this object, the [light entry]
 * calls its &#x60;postTo()&#x60; method that sends a &#x60;relay&#x60; command to the
 * [switch entry] together with the client socket. The [switch entry]
 * then creates a response socket and links the two sockets by calling
 * &#x60;Ose.link.open()&#x60;. The &#x60;open()&#x60; handler of the client socket is
 * then invoked. From now on, the switch response socket relays
 * &#x60;press&#x60;, &#x60;release&#x60;, &#x60;hold&#x60; and &#x60;tap&#x60; events to the client socket of
 * the [light entry].
 *
 * This example is composed of snippets from the following files:
 *
 * - Light entry kind: [ose-control/lib/light/index.js]
 * - Light client socket class: [ose-control/lib/light/switch.js]
 * - Switch entry kind: [ose-control/lib/switch/index.js]
 * - Switch response socket class: [ose-control/lib/switch/relay.js]
 *
 * Creation of client socket – [ose-control/lib/light/index.js]
 *
 *     // Create a client socket class
 *     var Switch = M.class(&#x27;ose-control/lib/light/switch&#x27;);
 *
 *     ...
 *     // Create a client socket when an entry is initializing
 *     new Switch(entry);
 *     ...
 *
 * Send a command to the [switch entry] after the client socket is initialized – [ose-control/lib/light/switch.js]
 *
 *     ...
 *     that.entry.postTo(
 *       that.entry.data.switch,
 *       &#x27;relay&#x27;,
 *       null,
 *       that
 *     );
 *     ...
 *
 * Create a switch response socket in [switch entry] &#x60;relay&#x60; command handler – [ose-control/lib/switch/index.js]
 *
 *     // Creates response socket class
 *     var Relay = M.class(&#x27;ose-control/lib/switch/relay&#x27;);
 *     ...
 *     // Registers a relay handler in the switch entry kind
 *     this.on(&#x27;relay&#x27;, relay);
 *     ...
 *     // Handler body
 *     function relay(req, socket) {
 *       // Creates response socket
 *       new Relay(this.entry, socket);
 *     };
 *
 * Open the link after response socket is initialized – [ose-control/lib/switch/relay.js]
 *
 *     // Open link; &#x60;this&#x60; is the response socket, and &#x60;socket&#x60; is the
 *     // client socket.  On both sides, the other socket is assigned to
 *     // the &#x60;link&#x60; property (e.g. &#x60;client.link = response&#x60;).
 *     Ose.link.open(this, socket, resp);
 *
 * The client&#x27;s &#x60;open()&#x60; handler is called – [ose-control/lib/light/switch.js].
 *
 *     exports.open = function(req) {
 *       ...
 *     };
 *
 *
 * ## Handlers
 * Each &#x60;socket&#x60; is an object with handlers attached to it. A handler
 * is a method directly assigned to a socket object (or a prototype
 * chain) with the handler&#x27;s &#x60;name&#x60; as the socket object&#x27;s key. A
 * socket is not an &#x60;EventEmitter&#x60;.
 *
 * Handlers are called directly via &#x60;this.link.handler(data)&#x60;, where
 * &#x60;handler&#x60; is the handler&#x27;s name and &#x60;this&#x60; is the the other socket
 * of the link.
 *
 * There are some special handlers:
 *
 * - &#x60;open([data])&#x60;:&lt;br /&gt;
 *   Invoked on the client side when the response calls
 *   &#x60;Ose.link.open(resp, client, data)&#x60;. On both sides, the other
 *   socket is assigned to the &#x60;link&#x60; property (e.g. &#x60;client.link =
 *   response&#x60;). There is no &#x60;open()&#x60; handler on the response side.
 *
 * - &#x60;close([data])&#x60;:&lt;br /&gt;
 *   Invoked when the link is gracefully closed by
 *   &#x60;Ose.link.close(socket, data)&#x60;. Can be called instead of
 *   &#x60;Ose.link.open()&#x60; from the response side. In such case the link
 *   is not opened and acts only as a callback. &#x60;Ose.link.close()&#x60;
 *   destroys the link and deletes the &#x60;link&#x60; property of both
 *   sockets.
 *
 * - &#x60;error(err)&#x60;:&lt;br /&gt;
 *   Invoked in the case of an error with &#x60;Ose.link.error(socket,
 *   err)&#x60;. &#x60;err&#x60; should be an instance of &#x60;Error&#x60;. &#x60;Ose.link.error()&#x60;
 *   destroys the link and deletes the &#x60;link&#x60; property of both sides.
 *   An error handler is invoked, for example, when the underlying
 *   WebSocket channel is closed.
 *
 * ## Network transparency
 *
 * TODO
 *
 * @todo
 * - Resolve LID conflicts
 *
 * @aliases link links socket sockets clientSocket responseSocket
 * @module ose
 * @submodule ose.link
 * @main ose.link
 */

/**
 * @caption Links helper
 *
 * @readme
 * This module contains methods for controlling links.
 *
 * @class ose.lib.link
 * @type module
 */

// }}}1
// Public {{{1
exports.prepare = function(socket) {  // {{{2
  socket._state = &#x27;WAIT&#x27;;
};

exports.open = function(socket, client, data) {  // {{{2
/**
 * Call by the response side to open a link. On both the response and
 * client side, the other socket is assigned to the &#x60;link&#x60; property
 * (e.g. &#x60;client.link = response&#x60;). The &#x60;open(data)&#x60; handler on the
 * client side is invoked.
 *
 * @param socket {Object} Reponse socket
 * @param client {Object} Client socket
 * @param data {Object} Data to be sent to the client
 *
 * @method open
 */
//  console.log(&#x27;LINK OPEN&#x27;);
//  console.trace();

  if (socket.link) {
    var err = Ose.error(socket, &#x27;DUPLICIT_LINK&#x27;);
    exports.error(socket, err);
    exports.error(client, err);
    return;
  }

  if (client.link) {
    var err = Ose.error(client, &#x27;DUPLICIT_LINK&#x27;);
    exports.error(client, err);
    exports.error(socket, err);
    return;
  }

  if (client._state !== &#x27;WAIT&#x27;)  {
    var err = Ose.error(client, &#x27;SOCKET_NOT_WAITING&#x27;);
    this.error(socket, err);
    this.error(client, err);
    return;
  }

  socket.link = client;
  socket._state = &#x27;OPEN&#x27;;
  client.link = socket;
  client._state = &#x27;OPEN&#x27;;

  if (typeof client.open !== &#x27;function&#x27;) {
    exports.error(client, Ose.error(client, &#x27;missingHandler&#x27;, &#x27;open&#x27;));
    return;
  }

  client.open(data);
};

exports.close = function(socket, data) {  // {{{2
/**
 * Call to gracefully close a link. This method invokes &#x60;close(data)&#x60;
 * handlers on both the client and response side.
 *
 * @param [socket] {Object} Socket to be closed
 * @param [data] {Object} Data sent to the close handler
 *
 * @method close
 */

  switch (typeof socket) {
  case &#x27;undefined&#x27;:
    /*
    if (data) {
      M.log.error(Ose.error(this, &#x27;unhandledResponse&#x27;, data));
      return;
    }
    */
    return;
  case &#x27;object&#x27;:
    break;
  case &#x27;function&#x27;:
    socket(null, data);
    return;
  default:
    throw Ose.error(&#x27;invalidArgs&#x27;, arguments);
  }

  socket._state = &#x27;CLOSE&#x27;;
  if (socket.link) {
    var mate = socket.link;
    mate._state = &#x27;CLOSE&#x27;;

    delete mate.link;
    delete socket.link;

    if (typeof mate.close === &#x27;function&#x27;) {
      mate.close(data);
      delete mate.lid;
    } else {
      exports.error(mate, Ose.error(socket, &#x27;missingHandler&#x27;, &#x27;close&#x27;));
    }
  }

  if (typeof socket.close === &#x27;function&#x27;) {
    socket.close(data);
    delete socket.lid;
  } else {
    exports.error(socket, Ose.error(socket, &#x27;missingHandler&#x27;, &#x27;close&#x27;));
  }

  return;
};

exports.error = function(socket, err) {  // {{{2
/**
 * Call to close a link with an error. This method invokes
 * &#x60;error(data)&#x60; handlers on both the client and response side.
 *
 * @param socket {Object} Socket object
 * @param err {Object} &#x60;Error&#x60; instance
 *
 * @method error
 */

//  console.log(&#x27;LINK ERROR&#x27;, socket.lid);
//  M.log.error(err);

  switch (typeof socket) {
  case &#x27;null&#x27;:
  case &#x27;undefined&#x27;:
    M.log.error(err);
    return;
  case &#x27;object&#x27;:
    if (! socket) {
      M.log.error(err);
      return;
    }

    break;
  case &#x27;function&#x27;:
    socket(err);
    return;
  default:
    throw Ose.error(&#x27;invalidArgs&#x27;, arguments);
  }

  socket._state = &#x27;ERROR&#x27;;
  if (socket.link) {
    var mate = socket.link;
    mate._state = &#x27;ERROR&#x27;;

    delete mate.link;
    delete socket.link;

    if (typeof mate.error === &#x27;function&#x27;) {
      mate.error(err);
      delete mate.lid;
    } else {
      M.log.error(err);
      throw Ose.error(mate, &#x27;missingHandler&#x27;, &#x27;error&#x27;);
    }
  }

  if (typeof socket.error === &#x27;function&#x27;) {
    socket.error(err);
    delete socket.lid;
  } else {
    M.log.error(err);
    throw Ose.error(socket, &#x27;missingHandler&#x27;, &#x27;error&#x27;);
  }
};

exports.wsClose = function(data) {  // {{{2
//  console.log(&#x27;WS CLOSE&#x27;, this.lid);

  if (this.ws &amp;&amp; this.ws.isConnected()) {
    this.ws.tx({
      type: &#x27;close&#x27;,
      lid: this.lid,
      data: data,
    });

    this.ws.delLid(this.lid);
    delete this.ws;
  }

  delete this.lid;
};

exports.wsError = function(err) {  // {{{2
  if (this.lid &amp;&amp; this.ws &amp;&amp; this.ws.isConnected()) {
    this.ws.txError(this.lid, err);

    this.ws.delLid(this.lid);
  }

  delete this.lid;
  delete this.ws;
};

exports.enumHandlers = function(socket) {  // {{{2
  var result = [];
  var p = socket.M.ctor.prototype;
  var h = Object.getOwnPropertyNames(p);
  for (var i = 0; i &lt; h.length; i++) {
    var key = h[i];

    if (typeof p[key] !== &#x27;function&#x27;) continue;

    switch (key) {
    case &#x27;open&#x27;:
    case &#x27;close&#x27;:
    case &#x27;error&#x27;:
      break;
    default:
      if (key in exports.forbiddenNames) {
        throw Ose.error(socket, &#x27;HANDLER_FORBIDDEN&#x27;, key);
      }

      result.push(key);
    }
  }

  if (! result.length) result = undefined;

  Object.defineProperty(p, &#x27;handlers&#x27;, {
    configurable: false,
    enumerable: false,
    writable: false,
    value: result,
  });
};

exports.bindHandlers = function(socket, handlers) {  // {{{2
  for (var i = 0; i &lt; handlers.length; i++) {
    var name = handlers[i];

    if (name in socket) {
      return Ose.error(socket, &#x27;DUPLICIT_HANDLER&#x27;, name);
    }

    if (exports.forbiddenNames.indexOf(name) &gt;= 0) {
      return Ose.error(socket, &#x27;HANDLER_FORBIDDEN&#x27;, key);
    }

    socket[name] = txCommand.bind(socket, name);
  }

  return null;
};

exports.relay = function(ws, name, req, socket) {  // {{{2
/**
 * Relay &#x60;req&#x60; to &#x60;ws&#x60;.
 */

  if (socket) {
    socket.handlers = undefined;
    ws.addLink(socket);
    socket.link = &#x27;relay&#x27;;
  }

  ws.tx(req);
};

exports.bindResp = function(m, path) {  // {{{2
  var c;

  return function(req, socket) {
    if (! c) {
      c = m.class(path);
    }

    var resp = new c(this.entry);

    exports.open(resp, socket);
  }
};

exports.forbiddenNames = [  // {{{2
/**
 * An array of handler names that can&#x27;t be used.
 *
 * @property forbiddenNames {Array}
 * @private
 */

  &#x27;close&#x27;,
  &#x27;error&#x27;,
  &#x27;link&#x27;,
  &#x27;lid&#x27;,  // TODO rename to &quot;_lid&quot;
  &#x27;M&#x27;,
  &#x27;open&#x27;,
  &#x27;_wsw&#x27;,  // TODO rename ws to &quot;_wsw&quot;
];

// }}}1
// Private {{{1
function txCommand(name, data, socket) {  // {{{2
  if (! (this.ws &amp;&amp; this.ws.isConnected())) {
    var err = Ose.error(this, &#x27;DISCONNECTED&#x27;, {command: name, data: data});
    Ose.link.error(socket, err);
    Ose.link.error(this, err);
    return;
  }

  var cmd = {
    type: &#x27;command&#x27;,
    lid: this.lid,  // Already created target socket lid.
    name: name,  // Command name to be called on target.
    data: data,  // Data to be sent to a command.
  };

  if (socket) {
    cmd.newLid = this.ws.addLink(socket);
    cmd.handlers = socket.handlers;
  }

  this.ws.tx(cmd);
  return;
};

// }}}1

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <!--script src="../assets/js/tabs.js"></script-->
  <script src="../assets/js/ose.js"></script>
</body>
</html>
