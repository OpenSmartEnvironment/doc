<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../ose/lib/plugins.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/bb.html#bb.box">bb.box</a></li> -->
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.dialog">bb.dialog</a></li> -->
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.pagelet">bb.pagelet</a></li> -->
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.widget">bb.widget</a></li> -->
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <!-- <li><a href="../modules/bb.html#bb.stateObj">bb.stateObj</a></li> -->
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/bundle.html#bundle.media">bundle.media</a></li> -->
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/control.html#control.distributor">control.distributor</a></li> -->
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.pin">control.pin</a></li> -->
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.room">control.room</a></li> -->
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <!-- <li><a href="../modules/control.html#control.remote">control.remote</a></li> -->
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/media.html#media.history">media.history</a></li> -->
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.player">media.player</a></li> -->
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.stream">media.stream</a></li> -->
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <!-- <li><a href="../modules/media.html#media.source">media.source</a></li> -->
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <!-- <li><a href="../modules/ose.html#ose.data">ose.data</a></li> -->
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.http">ose.http</a></li> -->
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.peer">ose.peer</a></li> -->
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.link">ose.link</a></li> -->
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.logger">ose.logger</a></li> -->
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.plugin">ose.plugin</a></li> -->
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <!-- <li><a href="../modules/ose.html#ose.wrap">ose.wrap</a></li> -->
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/yoctopuce.html">yoctopuce</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/yoctopuce.content.html">yoctopuce.content</a></li>
            
                <li><a href="../classes/yoctopuce.lib.html">yoctopuce.lib</a></li>
            
                <li><a href="../classes/yoctopuce.lib.meteo.html">yoctopuce.lib.meteo</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../ose/lib/plugins.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.singleton(module, &#x27;EventEmitter&#x27;);
exports = M.init();

/** Doc {{{1
 * @caption Plugins
 *
 * @readme
 *
 * To run, each &#x60;OSE instance&#x60; requires a main configuration object
 * (JavaScript object or JSON). Each main configuration object
 * property contains configuration data for one plugin. A plugin can
 * be a class, singleton or module.
 *
 * All plugins are registered to the &#x60;Ose.plugins&#x60; singleton. This
 * singleton prepares configurations for the OSE browser instances as
 * part of the response to HTTP requests for &#x60;index.html&#x60;.
 *
 * During &#x60;OSE instance&#x60; startup, the following steps are carried out:
 * 1. Setup of the framework
 * 2. Preparation of plugins
 * 3. Configuration of plugins
 * 4. Asynchronous processing of plugin dependencies
 *
 * After all dependencies are processed, the &#x60;initialized&#x60; event is
 * emitted by &#x60;Ose.plugins&#x60;.
 *
 *
 * @description
 *
 * ## OSE framework setup
 *
 * Basic classes and singletons are set up depending on the specified
 * runtime environment (browser or server).
 *
 *
 * ## Preparation of plugins
 *
 * Each property of the main configuration object contains the
 * configuration of a single OSE plugin. The &#x60;id&#x60; property of each
 * plugin configuration specifies the module to be loaded with
 * &#x60;require()&#x60;. If the &#x60;id&#x60; property is omitted, the key of the plugin
 * configuration is taken as the module id.
 *
 * Any CommonJS module can be a plugin. If a module defines a class,
 * its instance is created without parameters and becomes a plugin.
 * If a module defines a singleton, it gets initialized without any
 * arguments. Modules not defining a class or singleton are simply
 * required.
 *
 *
 * ## Configuration of plugins
 *
 * After all plugins are created, individual plugins are configured
 * using the &#x60;plugin.config(data)&#x60; method, where &#x60;data&#x60; is taken from
 * the main configuration object for each plugin.
 *
 * The &#x60;config&#x60; method, if it exists, is called on every prototype in
 * a plugin prototype chain. It must not call the ancestor &#x60;config()&#x60;
 * method.
 *
 * During this step, dependencies can be registered by calling
 * &#x60;ose.plugins.addDependency()&#x60;.
 *
 *
 * ## Dependencies
 *
 * Each dependency is defined by a method with a callback and an
 * optional &#x27;test&#x27; parameter.
 *
 * Example:
 *
 * TODO addDependency(dependency, test) ...
 *
 * TODO dependency(cb)...
 *
 * When a dependency is processed, it must call the provided
 * callback. When the processing of one dependency ends, the next
 * dependency whose &#x60;test&#x60; method returns &#x60;TRUE&#x60; is found and
 * processed. Other dependencies can be added during this step. When
 * there are no more dependencies left, the &#x60;initialized&#x60; event is
 * emitted by &#x60;Ose.plugins&#x60;.
 *
 * To run some code after all plugins are initialized, register a
 * method via &#x60;Ose.plugins.on(&#x27;initialized&#x27;, &lt;method&gt;)&#x60; during the
 * &quot;configuration&quot; or &quot;dependencies&quot; phase.
 *
 *
 * ## Extending
 *
 * It is easy to extend OSE by creating a new npm package and adding
 * an empty object with the package name as a key to the main
 * configuration object of an [OSE instance].
 *
 * To use some configuration, define the &#x60;config()&#x60; method on the
 * package&#x27;s main &#x60;module.exports&#x60; and provide some configuration data
 * to the package configuration property of the main configuration
 * object. The [Plugins component] then initializes the new package as
 * another OSE plugin during startup of an [OSE instance].
 *
 * TODO: example
 *
 * @aliases osePlugin oseConfig pluginsComponent
 *
 * @module ose
 * @submodule ose.plugin
 * @main ose.plugin
 */

/** TODO
 * @caption Plugins singleton
 *
 * @readme
 * Handles plugin instances defined in configuration file (or object).
 *
 * @class ose.lib.plugins
 * @type singleton
*/

// Public {{{1
exports.config = function(data) {  // Create all plugins defined in &quot;data&quot;, emit &quot;initialized&quot; after all plugins are initialized. {{{2
  if (this.setMaxListeners) this.setMaxListeners(1000);

  M.log.notice(&#x27;Reading configuration, creating plugins ...&#x27;);

  // Create and register all plugins.
  for (var key in data) {
    if (key in Plugins) {
      throw Ose.error(&#x27;duplicitPlugin&#x27;, key);
    }

    var value = data[key];
    if (typeof value === &#x27;string&#x27;) {  // Plugin configuration can be in a single file.
      value = require(value);
    }

    if (typeof value !== &#x27;object&#x27;) {
      throw Ose.error(this, &#x27;invalidPluginConfig&#x27;, {key: key, config: value});
    }

    var plugin = require(value.id || key)

//    console.log(&#x27;CONFIGURING&#x27;, key, value, typeof plugin.config);

    if (plugin.M) {
//      console.log(&#x27;CONFIGURING M&#x27;, key, typeof plugin.config);

      plugin = plugin.M;

      switch (plugin.type) {
      case &#x27;class&#x27;:
        plugin = new (plugin.ctor)();  // Create new instance.
        break;
      case &#x27;package&#x27;:
      case &#x27;singleton&#x27;:
        if (&#x27;_init&#x27; in plugin) {
          plugin = plugin.exports;  // Already initialized singleton.
        } else {
          plugin = plugin.init();  // Initialize singleton
        }
        break;
      default:
        throw Ose.error(plugin, &#x27;invalidModule&#x27;, value);
      }
    }

    Plugins[key] = {
      plugin: plugin,
      data: value,
    };
  }

  M.log.notice(&#x27;Plugins created, calling config() ...&#x27;);

  for (var key in Plugins) {
    var item = Plugins[key];
    var plugin = item.plugin;

    if (plugin.M) {
      Ose.callChain(plugin, &#x27;config&#x27;, key, item.data);
    } else {
      if (typeof plugin.config === &#x27;function&#x27;) {
        plugin.config(key, item.data);
      }
    }
  }

  M.log.notice(&#x27;Plugins configured, calling dependencies ...&#x27;);

  // Call dependencies.
  var timeout;
  callDependency();

  function callDependency() {  // {{{3
    if (timeout) clearTimeout(timeout);

    var dep = nextDependency();

    if (dep) {
      if (typeof dep === &#x27;number&#x27;) {
        throw Ose.error(this, &#x27;pendingDependencies&#x27;);
      }

//      console.log(&#x27;CALL DEPENDENCY&#x27;, Dependencies.length, dep.index);

      timeout = setTimeout(onTime.bind(dep), 2000);
      delete Dependencies[dep.index];
      Ose._.defer(dep.cb, callDependency);
    } else {
      Dependencies = [];
      M.log.notice(&#x27;Plugins, successfully initialized.&#x27;);

      exports.emit(&#x27;initialized&#x27;);
    }
  }

  function nextDependency() {  // {{{3
    var count = 0;
    var result;

    for (var i = 0; i &lt; Dependencies.length; i++) {
      var result = Dependencies[i];

      if (! result) continue;

      count++;

      if (typeof result === &#x27;function&#x27;) {
        return {
          cb: result,
          index: i
        };
      }

      switch (typeof result.test) {
        case &#x27;function&#x27;:
          if (result.test()) {
            return {
              cb: result.cb,
              index: i
            };
          }
          break;
        case &#x27;number&#x27;:
          if (! Dependencies[result.test]) {
            return {
              cb: result.cb,
              index: i
            };
          }
          break;
        default:
          throw new Error(&#x27;Unhandled condition&#x27;);
      }
    }

    return count;
  }

  function onTime() {  // {{{3
    throw Ose.error(exports, &#x27;Dependency timeout.&#x27;);

    callDependency();
  }

  // }}}3
};

exports.addDependency = function(test, cb) {  // Adds dependency, returns dependency index (handle). {{{2
  // test:
  //   undefined: &quot;cb&quot; can be called whenever.
  //   function: &quot;cb&quot; can be called after &quot;test()&quot; returns true value.
  //   number: &quot;cb&quot; can be called after dependency with number &quot;test&quot; is done.

  if ((typeof test === &#x27;function&#x27;) &amp;&amp; ! cb) {
    Dependencies.push(test);
  } else {
    Dependencies.push({
      test: test,
      cb: cb
    });
  }

  return Dependencies.length - 1;
};

exports.get = function(name) {  // Find plugin by its name and return it. {{{2
  if (! (name in Plugins)) {
    throw Ose.error(this, &#x27;missingPlugin&#x27;, name);
  }

  return Plugins[name];
};

exports.respondConfig = function(req, resp, params) {  // {{{2
  var data = [&#x27;window.ose(&quot;ose/config&quot;, &quot;ose/config.js&quot;, function(exports, require, module, __filename, __dirname) {&quot;use strict&quot;;\n&#x27;];

  for (var key in Plugins) {
    var p = Plugins[key];

    if (! p.plugin.browserConfig) continue;

    data.push(&#x27;exports[&#x27; + JSON.stringify(key) + &#x27;] = &#x27; + JSON.stringify(browserConfig(p.plugin, p.data), null, 2) + &#x27;;\n&#x27;);
  };

  data.push(&#x27;});&#x27;)
//    resp.setHeader(&#x27;ETag&#x27;, etag);
  resp.statusCode = 200;

  resp.end(data.join(&#x27;\n&#x27;));
};

exports.extend = function(config, ext) {  // {{{2
//  console.log(&#x27;EXTENDING&#x27;, config, ext);
  for (var key in ext) {
    var c = config[key];

    if (typeof c === &#x27;object&#x27;) {
      exports.extend(c, ext[key]);
    } else {
      config[key] = ext[key];
    }
  }
//  console.log(&#x27;EXTENDED&#x27;, config);
};

exports.push = function(key, plugin, data) {
/**
 * Adds configuration item to configuration object for the browser.
 *
 * @param key {String} Configuration name
 * @param plugin {Object} Plugin
 * @param data {Object} Configuration data
 *
 * @method push
 */

  Plugins[key] = {
    plugin: plugin,
    data: data || {},
  };
};

// }}}1
// Private {{{1
var Plugins = {};
var Dependencies = [];

function browserConfig(plugin, data) {  // {{{2
  var result;
  switch (typeof plugin.browserConfig) {
  case &#x27;boolean&#x27;:
    return data;
  case &#x27;function&#x27;:
    var result = {
      id: data &amp;&amp; data.id,
    };

    plugin.browserConfig(result, data);
    return result;
  case &#x27;object&#x27;:
    return plugin.browserConfig;
  }

  throw Ose.error(plugin, &#x27;invalidBrowserConfig&#x27;, plugin.browserConfig);
};

// }}}1

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <!--script src="../assets/js/tabs.js"></script-->
  <script src="../assets/js/ose.js"></script>
</body>
</html>
