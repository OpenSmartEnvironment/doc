<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../ose/lib/shard/index.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <li><a href="../modules/bundle.lirc.html">bundle.lirc</a></li>
                        
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                            <li><a href="../modules/bundle.rpi.html">bundle.rpi</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/yoctopuce.html">yoctopuce</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.lirc.html">bundle.example.lirc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.example.rpi.html">bundle.example.rpi</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.config.html">bundle.examples.lirc.config</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.lirc.html">bundle.examples.lirc.lirc</a></li>
            
                <li><a href="../classes/bundle.examples.media.channels.html">bundle.examples.media.channels</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.examples.media.streams.html">bundle.examples.media.streams</a></li>
            
                <li><a href="../classes/bundle.examples.rpi.config.html">bundle.examples.rpi.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.remote.html">media.lib.player.remote</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/yoctopuce.content.html">yoctopuce.content</a></li>
            
                <li><a href="../classes/yoctopuce.lib.html">yoctopuce.lib</a></li>
            
                <li><a href="../classes/yoctopuce.lib.meteo.html">yoctopuce.lib.meteo</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../ose/lib/shard/index.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.class(module, C, &#x27;EventEmitter&#x27;);

var Entry = M.class(&#x27;../entry&#x27;);
//var EntryMaster = M.class(&#x27;../entry/master&#x27;);
var Scope = M.class(&#x27;../scope&#x27;);
var Slave = M.class(&#x27;./slave&#x27;);
var Master = M.class(&#x27;./master&#x27;);

/** Doc {{{1
 * @module ose
 * @submodule ose.data
 */

/**
 * @caption Shard class
 *
 * @readme
 * A shard is a set of [entries]. Each shard belongs to a certain
 * [space]. Every shard has a &#x60;sid&#x60; (shard id) that is unique within
 * its [space]. Each shard is tied to a single [scope] (ie. it cannot
 * contain [entries] of [kinds] belonging to different
 * [scopes]). Every shard either belongs to the same [home] as its
 * space or is assigned to a different one.
 *
 * @aliases shard shards
 *
 * @class ose.lib.shard
 * @type class
 */

/**
 * Scope instance
 *
 * @property scope
 * @type String|Object
 */

/**
 * Space containing shard
 *
 * @property space
 * @type Object
 */

/**
 * Shard id unique within a space
 *
 * @property sid
 * @type Number
 */

/**
 * Shard alias
 *
 * @property alias
 * @type String
 */

/**
 * Home peer
 *
 * @property home
 * @type String|Object
 */

/**
 * Object containing entries
 *
 * @property cache
 * @type Object
 */

/**
 * Socket linked to the master shard
 *
 * @property master
 * @type Object
 */

/**
 * Whether the shard can communicate with its [home]
 * TODO: Consider renaming
 *
 * @property synced
 * @type Boolean
 */

/**
 * Whether the shard has been initialized
 *
 * @property initialized
 * @type Boolean
 */

/**
 * Gets fired after all shards is the current space are initialized
 *
 * @event afterInit
 * @param {Function} Callback to be called when the work is done.
 */

/**
 * Is fired when the &#x60;synced&#x60; property changes
 *
 * @event synced
 * @param {Boolean} Whether the shard is in sync with its home.
 */

// Public {{{1
// exports.peer = &lt;string&gt; || &lt;peer&gt;: Master peer, when initialized it changes from string to Peer object.
// exports.masterTimeOffset = &lt;integer&gt; Time offset between this peer and shards home in miliseconds.

function C(scope, space, sid, alias, home) {  // {{{2
/**
 * Class constructor
 *
 * @param scope {String|Object} Scope instance
 * @param space {Object} Space
 * @param sid {Number} Shard id
 * @param alias {String} Shard alias
 * @param [home] {String|Object} Home peer
 *
 * @method C
 */

  M.super.call(this);

  this.setMaxListeners &amp;&amp; this.setMaxListeners(1000);

  this.synced = null;

  this.masterTimeOffset = 0;

  this.cache = {};

//  this.id = id;  TODO: Remove from shard.

  this.space = space;
  this.sid = sid;
  this.alias = alias;

  switch (typeof scope) {
  case &#x27;string&#x27;:
    this.scope = Ose.scope(scope);
    break;
  case &#x27;object&#x27;:
    if (! M.isSuper(Scope, scope)) {
      throw Ose.error(this, &#x27;invalidScope&#x27;, {scope: scope});
    }

    this.scope = scope;
    break;
  default:
    throw Ose.error(this, &#x27;invalidScope&#x27;, {scope: scope});
  }

  switch (typeof home) {
  case &#x27;null&#x27;:
  case &#x27;undefined&#x27;:
    break;
  case &#x27;string&#x27;:
    this.home = Ose.peers.peer(home);
    break;
  case &#x27;object&#x27;:
    if (home) {
      this.home = home;
    }
    break;
  default:
    throw Ose.error(this, &#x27;invalidHome&#x27;, {home: home});
  }

  if (this.scope.name === &#x27;core&#x27;) {
    if (this.home) {
      this.home.coreShard(this);
    } else {
      this.space.home.coreShard(this);
    }
  }

  M.log.notice(&#x27;New Shard&#x27;, {scope: this.scope.name, space: this.space.name, shard: this.alias || this.sid});
};

exports.afterInit = function() {  // {{{2
/**
 * Gets called after all shards is the current space are initialized
 *
 * @method afterInit
 */

  this.initialized = true;

  if (this.atHome()) {
    this.setSynced(true);
  } else {
    this.setSynced(false);
    if (this.check2Link()) {
      this.linkMaster();
    };
  }

  this.emit(&#x27;afterInit&#x27;);
};

exports.check2Link = function() {  // {{{2
/**
 * Check whether this shard needs to be linked to the master.
 *
 * @returns {Boolean}
 *
 * @method check2Link
 */

//  console.log(&#x27;SHARD CHECK TO LINK&#x27;, {shard: this.identify(), synced: this.synced});

  // Check whether shard has some slaves
  if (this.slaves) {
    return true;
  }

  // Check whether something listens for &quot;synced&quot; event
  var l = this.listeners ? this.listeners(&#x27;synced&#x27;) : this.getListeners(&#x27;synced&#x27;);
  if (l &amp;&amp; l.length) {
    return true;
  }

  // Check whether some entry needs to be synced.
  for (var key in this.cache) {
    if (this.cache[key].slaves) {
      return true;
    }
  }

  return false;
};

exports.afterHome = function(cb) {  // {{{2
/**
 * Executes callback after the shard has been initialized, but only in
 * the [home OSE instance].
 *
 * @param cb {Function} Method to be called
 *
 * @method afterHome
 * @async
 */

  if (! this.atHome()) return;

  switch (typeof cb) {
  case &#x27;string&#x27;:
    cb = require(cb);
    break;
  case &#x27;function&#x27;:
    break;
  default:
    throw Ose.error(this, &#x27;invalidArgs&#x27;, arguments);
  }

  var that = this;

  var args = arguments.length &gt; 1 ?
    Ose._.rest(arguments) :
    null
  ;

  if (this.initialized) {
    setTimeout(done, 0);
  } else {
    this.once(&#x27;afterInit&#x27;, done);
  }

  function done() {
    if (args) {
      cb.apply(that, args);
    } else {
      cb(that);
    }
  }
};

exports.atHome = function() {  // {{{2
/**
 * Returns true if shard is in its home
 *
 * @returns {Boolean}
 *
 * @method atHome
 */

//  console.log(&#x27;SHARD AT home&#x27;, this.alias || this.id, ! (&#x27;mid&#x27; in this));

  return ((this.home || this.space.home).name === Ose.name);
};

exports.entry = function(id, kind, data) {  // {{{2
/**
 * Creates a new entry and adds it to &#x60;this.cache&#x60;.
 *
 * @param id
 * @param kind
 * @param data
 *
 * @returns {Object} Created entry
 *
 * @method entry
 */

  var result = new Entry(this, id);
  result.data = data;
  result.setup(kind);

  return result;
};

exports.get = function(entry, cb) {  // {{{2
/** Doc {{{3
 * Get entry with data in the current shard.
 *
 * @param entry {String|Number} Entry id.
 * @param cb {Function} Callback with entry as a response
 *
 * @method get
 */

//  console.log(&#x27;SHARD GET&#x27;, entry);

  if (! this.initialized) {  // Shard is not yet initialized, defer method call {{{3
    this.once(&#x27;afterInit&#x27;, this.get.bind(this, entry, cb));
    return;
  }

  if (this.atHome()) {  // Shard is at home {{{3
    if (entry in this.cache) {
      cb(null, this.cache[entry]);
      return;
    }

    cb(Ose.error(this, &#x27;ENTRY_NOT_FOUND&#x27;, entry));
    return;
  }

  var e; // Test whether entry is in shards cache {{{3
  if (entry in this.cache) {
    e = this.cache[entry];
    if (e.kind) {
      cb(null, e);
      return;
    }

    cb(M.log.todo(&#x27;Entry is created and waiting for the kind&#x27;, this, entry));
    return;
  }

  if (this.cached) {  // Entry is not in cache and shard contain all entries =&gt; entry not found {{{3
    cb(Ose.error(this, &#x27;ENTRY_NOT_FOUND&#x27;, entry));
    return;
  }

  // Create new entry and request data from master {{{3
  e = new Entry(this, entry);
  e.linkMaster(cb);

  // }}}3
};

exports.link = function(entry, req, socket) {  // {{{2
/** Doc {{{3
 * Establish a link to an entry in the current shard.
 *
 * @param entry {String|Number} Entry id.
 *
 * @param req {Object} Request object
 * @param req.drev {Object} Current data revision. Specifies whether to request entry data.
 * @param req.dtrack {Boolean} Whether to track data changes
 * @param req.srev {Object} Current state revision. Specifies whether to request entry state.
 * @param req.strack {Boolean} Whether to track state changes
 *
 * @param socket {Object|Function} Socket to be linked as a slave to an entry | Callback with entry as a response
 *
 * @method link
 */

//  console.log(&#x27;SHARD LINK&#x27;, entry, req);

  switch (arguments.length) {  // Process arguments {{{3
  case 3:
    if (typeof socket === &#x27;object&#x27;) {
      break;
    }
  default:
    throw Ose.error(this, &#x27;invalidArgs&#x27;, arguments);
  }

  if (! this.initialized) {  // Shard is not yet initialized =&gt; defer method call {{{3
    this.once(&#x27;afterInit&#x27;, this.link.bind(this, entry, req, socket));
    return;
  }

  if (this.atHome()) {  // Shard is at home {{{3
    if (entry in this.cache) {
//      new EntryMaster(this.cache[entry], req, socket);
      this.cache[entry].linkSlave(req, socket);
      return;
    }

    Ose.link.error(socket, Ose.error(this, &#x27;ENTRY_NOT_FOUND&#x27;, entry));
    return;
  }

  if (entry in this.cache) {  // Get entry from cache {{{3
    this.cache[entry].linkSlave(req, socket);
    return;
  }

  if (this.cached) {  // Entry is not in cache and shard contain all entries =&gt; entry not found {{{3
    Ose.link.error(socket, Ose.error(this, &#x27;ENTRY_NOT_FOUND&#x27;, entry));
    return;
  }

  // Create new entry {{{3
  new Entry(this, entry).linkSlave(req, socket);
  return;

  // }}}3
};

exports.send = function(target, name, data, socket) {  // {{{2
/**
 * Send a command to shard&#x27;s home
 *
 * @param entry {String|Number} Entry id.
 * @param name {String} Command name
 * @param [data] {*} Data to be sent
 * @param [socket] {Object} Slave socket
 *
 * @method send
 */

//  console.log(&#x27;SHARD SEND&#x27;, target, name, data);

  if (! (target &amp;&amp; name)) {
    Ose.link.error(socket, Ose.error(this, &#x27;INVALID_ARGS&#x27;, {target: target, name: name, data: data}));
    return;
  }

  this.linkMaster(function(err, sm) {
    if (err) {
      Ose.link.error(socket, err);
      return;
    }

    if (sm.link) {
      sm.link.command({target: target, name: name, data: data}, socket);
      return;
    }

    Ose.link.error(socket, M.log.todo(&#x27;&#x60;shard.linkMaster()&#x60; should always return linked master or error!&#x27;, arguments));
    return;
  });
};

exports.findShard = function(req, cb) {  // {{{2
/**
 * Finds a shard by id or alias in the same space as this shard or by
 * an identification object in another space
 *
 * @param req {Number|String|Object} Requested shard (sid or alias) in the current space or object also specifying another space.
 * @param [req.space] {String} Space name
 * @param [req.shard] {Number|String} Shard id or alias
 *
 * @param cb {Function} Response callback
 *
 * @method findShard
 * @async
 */

//  console.log(&#x27;SHARD FIND SHARD&#x27;, {shard: this.alias || this.sid, req: req, initialized: this.initialized});

  if (! this.initialized) {
    this.once(&#x27;afterInit&#x27;, this.findShard.bind(this, req, cb));
    return;
  }

  switch (typeof req) {
  case &#x27;string&#x27;:
  case &#x27;number&#x27;:
    this.space.findShard(req, cb);
    return;
  case &#x27;object&#x27;:
    if ((&#x27;space&#x27; in req) &amp;&amp; (req.space !== this.space.name)) {
      Ose.spaces.findShard(req, cb);
      return;
    }

    this.space.findShard(req.shard, cb);
    return;
  }

  throw Ose.error(this, &#x27;invalidArgs&#x27;, arguments);
};

exports.getView = function(params, socket) {  // {{{2
/**
 * **Views logic will be changed in principle**
 *
 * @param params {Object} Parameters
 * @param socket {Object|Function} Slave socket or callback
 *
 * @method getView
 * @beta
 */

//  console.log(&#x27;SHARD GET VIEW&#x27;, this.sid || this.alias, params);

  if (! params) params = {};

/*
  if ((&#x27;mid&#x27; in this) &amp;&amp; ! this.cached) {
    params.shard = this.mid;
    this.sendMaster(&#x27;view&#x27;, params, cb);
    return;
  }
*/

  if (! (this.cached || this.atHome())) {
    this.linkMaster(function(err, master) {
//      console.log(&#x27;MASTER CONNECTED&#x27;, err);
      if (err) {
        Ose.link.error(socket, err);
      } else {
        master.link.view(params, socket);
      }
    });

    return;

//    Ose.link.error(socket, Ose.error(this, &#x27;socketDisconnected&#x27;));
//    return;
  }

  if (params.kind) {
    var kind = this.scope.kinds[params.kind];

    if (kind.getView) {
      params.shard = this;
      kind.getView(params, socket);
      return;
    }
  }

  var result = [];
  for (var key in this.cache) {
    var entry = this.cache[key];

    if (entry.inView(params)) {
      result.push(entry.id);
    }
  }

  Ose.link.close(socket, {view: result});
  return;
};

exports.identify = function() {  // {{{2
/**
 * Returns shard identification object. This object consists of &#x60;space
 * name&#x60; and &#x60;shards sid&#x60;.
 *
 * @returns {Object} Shard identification object.
 *
 * @method identify
 */

  return {
    space: this.space.name,
    shard: this.sid
  };
};

exports.isIdentified = function(data) {  // {{{2
/**
 * Checks whether this shard is identified by a &#x60;data&#x60; identification
 * object.
 *
 * @param data {Object} Identification object
 *
 * @returns {Boolean}
 *
 * @method isIdentified
 */

  if (data.space !== undefined) {
    if (this.space.name !== data.space) return false;

    return (this.alias === data.shard) || (this.sid === data.shard);
  } else {
    return this.id === data.shard;
  }
};

exports.setSynced = function(value) {  // {{{2
/**
 * Sets &#x60;synced&#x60; property. Emits &#x60;synced&#x60; event if the property is
 * changed.
 *
 * @param value {Boolean} Value to be set
 *
 * @method setSynced
 */

  if (typeof value !== &#x27;boolean&#x27;) throw Ose.error(this, &#x27;invalidSynced&#x27;, value);

  if (value === this.synced) return;

  this.synced = value;
  this.emit(&#x27;synced&#x27;, value);

  if (this.slaves) {
    for (var key in this.slaves) {
      var s = this.slaves[key];
      if (s.link) {
        s.link.synced(value);
      }
    }
  }

//  console.log(&#x27;SHARD SYNCED&#x27;, {shard: this.identify(), value: this.synced});
};

exports.afterSynced = function(cb) {  // {{{2
/**
 * Calls the callback after the shard gets synced with its home or
 * immediately if already in sync. It can wait forever.
 *
 * @param cb {Function} Callback
 *
 * @method afterSynced
 */

//  console.log(&#x27;SHARD AFTER SYNCED&#x27;, {shard: this.identify(), synced: this.synced});

  if (this.synced) {
    cb();
    return;
  }

  var that = this;

  if (this.atHome()) {
    if (this.initialized) {
      throw Ose.error(this, &#x27;UNEXPECTED&#x27;, &#x27;Shard is at home and initialized and has not &#x60;synced&#x60; property defined as &#x60;true&#x60;.&#x27;, this.synced);
    }

    this.once(&#x27;synced&#x27;, test);
    return;
  }

  this.linkMaster(test);
  /*
  this.linkMaster(function(err) {
    switch (err &amp;&amp; err.code) {
    case null:
    case undefined:
    case &#x27;UNREACHABLE&#x27;:
    case &#x27;DISCONNECTED&#x27;:
      test();
      return;
    }

    cb(err);
  });
  */
  return;

  function test() {
    if (that.synced) {
//      console.log(&#x27;SHARD AFTER SYNCED SUCCESS&#x27;, {shard: that.identify(), synced: that.synced});
      cb();
    } else {
      that.once(&#x27;synced&#x27;, test);
    }
  };
};

exports.linkSlave = function(socket) {  // {{{2
/**
 * Opens a link to the slave shard
 *
 * @param socket {Object} Client socket
 *
 * @method linkSlave
 */

  if (this.slaves) {
    if (socket.lid in this.slaves) {
      Ose.link.error(socket, Ose.error(this, &#x27;DUPLICIT&#x27;, socket.lid));
      return;
    }
  } else {
    this.slaves = {};
  }

  var m = new Master();

  m.shard = this;
  this.slaves[socket.lid] = m;

  Ose.link.open(m, socket, {
    alias: this.alias,
    synced: this.synced
  });

  if (! this.synced) {
    this.linkMaster();
  }

  return;
};

exports.linkMaster = function(cb) {  // {{{2
/**
 * Establishes a link to the master shard if it doesn&#x27;t exist and
 * provides a shard/slave socket as a callback response.
 * Should be called only when not at home.
 * &#x60;shard.master&#x60; is removed only when it is unnecessary - the shard doesn&#x27;t needs to be synced to its home.
 *
 * @param cb {Function(err, shardMaster)}
 *
 * @method linkMaster
 * @async
 */

  if (! this.initialized) {  // Shard is not yet initialized, defer method call
    this.once(&#x27;afterInit&#x27;, this.linkMaster.bind(this, cb));
    return;
  }

//  console.log(&#x27;SHARD LINK MASTER&#x27;, {name: this.alias || this.sid, home: this.home &amp;&amp; this.home.name, typeofCb: typeof cb});

  var peer = findGw(this.home || this.space.home);
  if (! peer) {
    cb(Ose.error(this, &#x27;NO_ROUTE&#x27;, &#x27;Route to shard\&#x27;s home is not defined.&#x27;));
    return;
  }

  if (this.master) {
    if (
      this.master.link &amp;&amp;
      this.master.link.ws &amp;&amp;
      this.master.link.ws.isConnected()
    ) {
      cb &amp;&amp; cb(null, this.master);
      return;
    }

    if (this.master._state !== &#x27;WAIT&#x27;) {
      cb &amp;&amp; cb(Ose.error(this, &#x27;DISCONNECTED&#x27;));
      return;
    }

    this.master.once(&#x27;done&#x27;, cb);
    return;
  }

  new Slave(this, peer, cb);
  return;

  function findGw(peer) {  // {{{3
    if (peer === Ose.peers.here) {
      return null;
    }

    if (peer.isConnected() || peer.url) {
      return peer;
    }

    if (peer.gw) {
      if (peer.gw === Ose.peers.here) {
        return peer;
      }
      return peer.gw;
    }

    if (Ose.peers.gw) {
      if (Ose.peers.gw === Ose.peers.here) {
        return peer;
      }
      return Ose.peers.gw;
    }

    return peer;
  }

  // }}}3
};

// }}}1
// Private {{{1
function addEntry(that, entry) {  // {{{2
  if (! entry.id) {
    if (! that.entryId) {
      M.log.unhandled(&#x27;Cannot create new entry without id in slave shard.&#x27;);
      return false;
    }

    entry.id = that.entryId++;
  }

  if (entry.id in that.cache) {
    M.log.unhandled(&#x27;Entry with same id already exist in that shard.&#x27;, that.alias || that.id, entry);
    return false;
  }

  entry.shard = that;

  that.cache[entry.id] = entry;

  return true;
};

// }}}1

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <script src="../assets/js/ose.js"></script>
</body>
</html>
