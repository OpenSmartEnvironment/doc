<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../ose/lib/space/index.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <li><a href="../modules/bundle.lirc.html">bundle.lirc</a></li>
                        
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                            <li><a href="../modules/bundle.rpi.html">bundle.rpi</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/yoctopuce.html">yoctopuce</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.lirc.html">bundle.example.lirc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.example.rpi.html">bundle.example.rpi</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.config.html">bundle.examples.lirc.config</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.lirc.html">bundle.examples.lirc.lirc</a></li>
            
                <li><a href="../classes/bundle.examples.media.channels.html">bundle.examples.media.channels</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.examples.media.streams.html">bundle.examples.media.streams</a></li>
            
                <li><a href="../classes/bundle.examples.rpi.config.html">bundle.examples.rpi.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.remote.html">media.lib.player.remote</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/yoctopuce.content.html">yoctopuce.content</a></li>
            
                <li><a href="../classes/yoctopuce.lib.html">yoctopuce.lib</a></li>
            
                <li><a href="../classes/yoctopuce.lib.meteo.html">yoctopuce.lib.meteo</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../ose/lib/space/index.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.class(module, C);

var Shard = M.class(&#x27;../shard&#x27;);
//var SlaveShard = M.class(&#x27;../shard/slave&#x27;);

/**  Doc {{{1
 * @caption Data model
 *
 * @readme
 * The data model of the framework is designed so that individual
 * instances of OSE hold subsets of the data and together create a
 * single whole.
 *
 * Data partitions are called [shards]. Basic data units contained by
 * [shards] are called [entries].
 *
 * Each [entry] is of a certain [kind]. [Kinds] define the properties
 * and behaviour of [entries]. Kinds are namespaced using [scopes].
 *
 * Each [shard] belongs to a [space] that act as the shard&#x27;s
 * namespace. Each shard is tied to [scope] and can contain only
 * entries of kinds from that [scope].
 *
 * Kind hierarchy:
 * * scope
 *   * kind
 *
 * Data partitioning hierarchy:
 * * space
 *   * shard
 *     * entry
 *
 * Example:
 *
 * The &#x60;reading.light&#x60; is an entry of the kind &#x60;light&#x60;, the &#x60;light&#x60;
 * kind belongs to the &#x60;control&#x60; scope, and the &#x60;reading.light&#x60; entry
 * is saved in the shard &#x60;living.room&#x60;, which belongs to the space
 * &#x60;my.house&#x60;.
 *
 * @description
 *
 * ## Commands
 * It is possible to send commands to individual [entries]. Each
 * command is delivered to the [home] of an [entry]. Commands consist
 * of a command name and optional data. A command can be a request for
 * data or to establish a new [link].
 *
 * Command handlers can be registered for a [kind] with an &#x60;on()&#x60;
 * method call. The [Kind] class is not an [Event Emitter] descendant.
 * In command handler code, the target &#x60;entry&#x60; can be accessed in
 * &#x60;this.entry&#x60;.
 *
 * Example:
 *     TODO
 *
 * @planned
 * - Data persistency (LevelDB ?)
 * - Data encryption
 * - Sharing and authorization
 *
 * @aliases
 * command commands entryCommand entryCommands commandHandler commandHandlers
 *
 * @module ose
 * @submodule ose.data
 * @main ose.data
 */

/**
 * @caption Space class
 *
 * @readme
 * A space is a data namespace containing [shards]. It is identified
 * by its unique &#x60;name&#x60; (eg. a domain name or email address).
 *
 * @aliases space spaces
 *
 * @class ose.lib.space
 * @type class
 */

/**
 * Unique space name
 *
 * @property name
 * @type String
 */

/**
 * Home peer
 *
 * @property home
 * @type Object
 */

/**
 * Object containing shards indexed by &#x60;sid&#x60;
 *
 * @property shards
 * @type Object
 */

// Public {{{1
function C() {  // {{{2
/**
 * Class constructor
 *
 * @method init
 */

  this.shards = {};
};

exports.config = function(name, data) {  // {{{2
/**
 * Plugin configuration method
 *
 * @param name {String} Configuration name
 * @param data {Object} Plugin configuration
 *
 * @method config
 */

  this.name = data.name;
  if (! data.home) {
    throw Ose.error(this, &#x27;missingHome&#x27;, data);
  }
  this.home = Ose.peers.peer(data.home);

  Ose.spaces.add(this);
  ++InitSpaces;

  Ose.plugins.addDependency(afterConfig.bind(this, data));
  Ose.plugins.once(&#x27;initialized&#x27;, afterInit.bind(this));
};

exports.browserConfig = function(config) {  // {{{2
/**
 * Fills the configuration object for the browser.
 *
 * @param config {Object} Plugin configuration
 *
 * @method browserConfig
 */

  config.name = this.name;
  config.home = this.home.name;

  config.shards = [];

  for (var key in this.shards) {
    var shard = this.shards[key];

    config.shards.push({
      sid: shard.sid,
      scope: shard.scope.name,
      alias: shard.alias,
      home: shard.home &amp;&amp; shard.home.name,
    });
  };
};

exports.getShard = function(sid, cb) {  // {{{2
/**
 * Finds a shard by shard id (sid)
 *
 * @param sid {Number|String} Shard id
 * @param cb {Function} Response callback
 *
 * @method getShard
 * @async
 */

  if (sid in this.shards) {
    cb(null, this.shards[sid]);
    return;
  }

  cb(Ose.error(this, &#x27;SHARD_NOT_FOUND&#x27;));
  return;
};

exports.getShardAlias = function(alias, cb) {  // {{{2
/**
 * Finds a shard by shard alias
 *
 * @param sid {String} Shard alias
 * @param cb {Function} Response callback
 *
 * @method getShardAlias
 * @async
 */

  for (var key in this.shards) {
    var shard = this.shards[key];

    if (shard.alias === alias) {
      cb(null, shard);
      return;
    }
  }

  cb(Ose.error(this, &#x27;SHARD_NOT_FOUND&#x27;));
  return;
};

exports.findShard = function(req, cb) {  // {{{2
/**
 * Finds a shard by id or alias in the current space or by an
 * identification object in another space
 *
 * @param req {Number|String|Object} Requested shard (sid or alias) in the current space or object also specifying another space.
 * @param [req.space] {String} Space name
 * @param [req.shard] {Number|String} Shard id or alias
 *
 * @param cb {Function} Response callback
 *
 * @method findShard
 * @async
 */

//  console.log(&#x27;SPACE FIND SHARD&#x27;, this.name, req);

  if (typeof req === &#x27;object&#x27;) {
    if (req.space &amp;&amp; (req.space !== this.name)) {
      Ose.spaces.getShard(req, cb);
      return;
    }

    req = req.shard;
  }

  switch (typeof req) {
  case &#x27;number&#x27;:
    this.getShard(req, cb);
    return;
  case &#x27;string&#x27;:
    var sid = parseInt(req);

    if (isNaN(sid)) {
      this.getShardAlias(req, cb);
      return;
    }

    this.getShard(sid, cb);
    return;
  }

  throw Ose.error(this, &#x27;invalidArgs&#x27;, arguments);
};

exports.eachShard = function(filter, cb) {  // {{{2
/**
 * Calls a callback for each shard matching filtering criteria.
 *
 * @param filter {Object}
 * @param cb {Function (shard)} callback
 *
 * @method eachShard
 * @async
 */

//  console.log(&#x27;EACH SHARD&#x27;, filter);

  if (typeof filter === &#x27;function&#x27;) {
    cb = filter;
    filter = undefined;
  }

  if (&#x27;space&#x27; in filter) {
    if (filter.space !== this.name) return;
  }

  for (var key in this.shards) {
    var shard = this.shards[key];

    if (filter) {
      if (&#x27;scope&#x27; in filter) {
        if (filter.scope !== shard.scope.name) continue;
      }
/*
      if (filter.alias) {
        if (shard.alias !== filter.alias) continue;
      }

      if (filter.space) {
        if ((&#x27;sid&#x27; in filter) &amp;&amp; ! ((shard.sid === filter.sid) || (shard.alias === filter.sid))) continue;
      }
*/
    }

    cb(shard);
  }
};

exports.link = function(entry, req, socket) {  // {{{2
/**
 * Builds a new &#x60;link&#x60; to an &#x60;entry&#x60;.
 *
 * @param entry {Object} Entry identification
 * @param req {Object} Request
 * @param socket {Object} Slave socket instance
 *
 * @method link
 */

//  console.log(&#x27;OSE ENTRY&#x27;, entry, req);

  this.findShard(entry, function(err, shard) {
    if (err) {
      Ose.link.error(socket, err);
    } else {
      shard.link(entry.entry, req, socket);
    }
  });
};

// }}}1
// Event Handlers {{{1
function afterConfig(config, cb) {  // {{{2
  // Configure shards.
  for (var i = 0; i &lt; config.shards.length; i++) {
    initShard(this, config.shards[i]);
  }

  if (InitSpaces &gt; 0) {
    --InitSpaces;
  } else {
    M.log.unhandled(&#x27;InitSpaces, is too small!&#x27;);
  }

  cb();
};

function afterInit() {  // {{{2
  if (this.master) {
    this.master.connect();
  }

  for (var key in this.shards) {
    this.shards[key].afterInit();
  }
};

// }}}1
// Private {{{1
var InitSpaces = 0;

function spacesInitialized() {  // {{{2
  return InitSpaces === 0;
}

function initShard(that, config) {  // {{{2
  if (! config.sid) {
    throw Ose.error(that, &#x27;invalidSid&#x27;, config);
  }

  if (config.sid in that.shards) {
    throw Ose.error(that, &#x27;duplicitShard&#x27;, config);
  }

  var result = new Shard(config.scope, that, config.sid, config.alias, config.home);
  that.shards[result.sid] = result;

  if (config.cached) {
    result.cached = true;
  }

  if (result.atHome()) {
    if (config.homeInit) {
      homeInit(config.homeInit);
    }
  }

  if (config.entries) {
    initEntries(config.entries);
  }

  if (config.dependencies) {
    Ose.plugins.addDependency(spacesInitialized, initDependencies);
  }

  if (config.homeDeps &amp;&amp; result.atHome()) {
    Ose.plugins.addDependency(spacesInitialized, initHomeDeps);
  }

  return result;

  function homeInit(data) {  // {{{3
    if (Array.isArray(data)) {
      Ose._.each(data, homeInit);
    } else if (typeof data === &#x27;string&#x27;) {
      require(data)(result);
    } else {
      data(result);
    }
  };

  function initEntries(entry) {  // {{{3
    switch (typeof entry) {
    case &#x27;array&#x27;:
      Ose._.each(entry, initEntries);
      break;
    case &#x27;string&#x27;:
      initEntries(require(entry));
      break;
    case &#x27;function&#x27;:
      entry(result);
      break;
    case &#x27;object&#x27;:
      if (Array.isArray(entry)) {
        Ose._.each(entry, initEntries);
        break;
      }
    default:
      throw Ose.error(result, &#x27;invalidConfig&#x27;, entry);
    }
  };

  function initHomeDeps(cb) {  // {{{3
    var fn = config.homeDeps;
    if (typeof fn === &#x27;string&#x27;) {
      fn = require(fn);
    }

    fn(result, cb);
  };

  function initDependencies(cb) {  // {{{3
    var fn = config.dependencies;
    if (typeof fn === &#x27;string&#x27;) {
      fn = require(fn);
    }

    fn(result, cb);
  };

  // }}}3
};

// }}}1

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <script src="../assets/js/ose.js"></script>
</body>
</html>
