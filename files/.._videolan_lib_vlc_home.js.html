<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>../videolan/lib/vlc/home.js - ose-bundle</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
  <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
  <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
  <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
</head>
<body class="yui3-skin-sam">

  <div id="doc">
    <div class="yui3-g">

      <div id="sidebar" class="yui3-u">
        <a href="../index.html"><h2>OSE documentation</h2></a>

        <div class="sidebox">
          <div class="hd">
            <h2 class="no-toc">Type to filter sidebar:</h2>
          </div>
          <div class="bd">
            <input id="filter-input" />
          </div>
        </div>

        







<div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All packages and components</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/bb.html">bb</a>
                
                    <ul>
                        
                            <li><a href="../modules/bb.box.html">bb.box</a></li>
                        
                            <li><a href="../modules/bb.dialog.html">bb.dialog</a></li>
                        
                            <li><a href="../modules/bb.pagelet.html">bb.pagelet</a></li>
                        
                            <li><a href="../modules/bb.widget.html">bb.widget</a></li>
                        
                            <li><a href="../modules/bb.stateObj.html">bb.stateObj</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/boards.html">boards</a>
                
                </li>
            
                <li><a href="../modules/bundle.html">bundle</a>
                
                    <ul>
                        
                            <li><a href="../modules/bundle.lirc.html">bundle.lirc</a></li>
                        
                            <li><a href="../modules/bundle.media.html">bundle.media</a></li>
                        
                            <li><a href="../modules/bundle.rpi.html">bundle.rpi</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/control.html">control</a>
                
                    <ul>
                        
                            <li><a href="../modules/control.distributor.html">control.distributor</a></li>
                        
                            <li><a href="../modules/control.pin.html">control.pin</a></li>
                        
                            <li><a href="../modules/control.room.html">control.room</a></li>
                        
                            <li><a href="../modules/control.remote.html">control.remote</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/dvb.html">dvb</a>
                
                </li>
            
                <li><a href="../modules/fs.html">fs</a>
                
                </li>
            
                <li><a href="../modules/icecast.html">icecast</a>
                
                </li>
            
                <li><a href="../modules/lirc.html">lirc</a>
                
                </li>
            
                <li><a href="../modules/media.html">media</a>
                
                    <ul>
                        
                            <li><a href="../modules/media.history.html">media.history</a></li>
                        
                            <li><a href="../modules/media.player.html">media.player</a></li>
                        
                            <li><a href="../modules/media.stream.html">media.stream</a></li>
                        
                            <li><a href="../modules/media.source.html">media.source</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/ose.html">ose</a>
                
                    <ul>
                        
                            <li><a href="../modules/ose.data.html">ose.data</a></li>
                        
                            <li><a href="../modules/ose.http.html">ose.http</a></li>
                        
                            <li><a href="../modules/ose.peer.html">ose.peer</a></li>
                        
                            <li><a href="../modules/ose.link.html">ose.link</a></li>
                        
                            <li><a href="../modules/ose.logger.html">ose.logger</a></li>
                        
                            <li><a href="../modules/ose.plugin.html">ose.plugin</a></li>
                        
                            <li><a href="../modules/ose.wrap.html">ose.wrap</a></li>
                        
                    </ul>
                
                </li>
            
                <li><a href="../modules/pa.html">pa</a>
                
                </li>
            
                <li><a href="../modules/rpi.html">rpi</a>
                
                </li>
            
                <li><a href="../modules/videolan.html">videolan</a>
                
                </li>
            
                <li><a href="../modules/xorg.html">xorg</a>
                
                </li>
            
                <li><a href="../modules/yoctopuce.html">yoctopuce</a>
                
                </li>
            
                <li><a href="../modules/youtube.html">youtube</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">All modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/bb.content.html">bb.content</a></li>
            
                <li><a href="../classes/bb.lib.html">bb.lib</a></li>
            
                <li><a href="../classes/bb.lib.box.content.html">bb.lib.box.content</a></li>
            
                <li><a href="../classes/bb.lib.box.left.html">bb.lib.box.left</a></li>
            
                <li><a href="../classes/bb.lib.dialog.html">bb.lib.dialog</a></li>
            
                <li><a href="../classes/bb.lib.dialog.action.html">bb.lib.dialog.action</a></li>
            
                <li><a href="../classes/bb.lib.dialog.confirm.html">bb.lib.dialog.confirm</a></li>
            
                <li><a href="../classes/bb.lib.dialog.info.html">bb.lib.dialog.info</a></li>
            
                <li><a href="../classes/bb.lib.dialog.valueSelector.html">bb.lib.dialog.valueSelector</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.html">bb.lib.pagelet</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.dashboard.html">bb.lib.pagelet.dashboard</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.detail.html">bb.lib.pagelet.detail</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.entry.html">bb.lib.pagelet.entry</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.gesture.html">bb.lib.pagelet.gesture</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.list.html">bb.lib.pagelet.list</a></li>
            
                <li><a href="../classes/bb.lib.pagelet.listItem.html">bb.lib.pagelet.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.html">bb.lib.widget</a></li>
            
                <li><a href="../classes/bb.lib.widget.button.html">bb.lib.widget.button</a></li>
            
                <li><a href="../classes/bb.lib.widget.checkbox.html">bb.lib.widget.checkbox</a></li>
            
                <li><a href="../classes/bb.lib.widget.list.html">bb.lib.widget.list</a></li>
            
                <li><a href="../classes/bb.lib.widget.listItem.html">bb.lib.widget.listItem</a></li>
            
                <li><a href="../classes/bb.lib.widget.search.html">bb.lib.widget.search</a></li>
            
                <li><a href="../classes/bb.lib.widget.slider.html">bb.lib.widget.slider</a></li>
            
                <li><a href="../classes/bb.lib.widget.slideswitch.html">bb.lib.widget.slideswitch</a></li>
            
                <li><a href="../classes/bb.lib.widget.toolbar.html">bb.lib.widget.toolbar</a></li>
            
                <li><a href="../classes/boards.content.html">boards.content</a></li>
            
                <li><a href="../classes/boards.lib.html">boards.lib</a></li>
            
                <li><a href="../classes/bundle.doc.html">bundle.doc</a></li>
            
                <li><a href="../classes/bundle.example.lirc.html">bundle.example.lirc</a></li>
            
                <li><a href="../classes/bundle.example.media.html">bundle.example.media</a></li>
            
                <li><a href="../classes/bundle.example.rpi.html">bundle.example.rpi</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.config.html">bundle.examples.lirc.config</a></li>
            
                <li><a href="../classes/bundle.examples.lirc.lirc.html">bundle.examples.lirc.lirc</a></li>
            
                <li><a href="../classes/bundle.examples.media.channels.html">bundle.examples.media.channels</a></li>
            
                <li><a href="../classes/bundle.examples.media.config.html">bundle.examples.media.config</a></li>
            
                <li><a href="../classes/bundle.examples.media.streams.html">bundle.examples.media.streams</a></li>
            
                <li><a href="../classes/bundle.examples.rpi.config.html">bundle.examples.rpi.config</a></li>
            
                <li><a href="../classes/bundle.Gruntfile.html">bundle.Gruntfile</a></li>
            
                <li><a href="../classes/control.content.html">control.content</a></li>
            
                <li><a href="../classes/control.lib.html">control.lib</a></li>
            
                <li><a href="../classes/control.lib.activity.html">control.lib.activity</a></li>
            
                <li><a href="../classes/control.lib.din.html">control.lib.din</a></li>
            
                <li><a href="../classes/control.lib.din.pin.html">control.lib.din.pin</a></li>
            
                <li><a href="../classes/control.lib.distributor.html">control.lib.distributor</a></li>
            
                <li><a href="../classes/control.lib.door.html">control.lib.door</a></li>
            
                <li><a href="../classes/control.lib.door.pin.html">control.lib.door.pin</a></li>
            
                <li><a href="../classes/control.lib.flowMeter.html">control.lib.flowMeter</a></li>
            
                <li><a href="../classes/control.lib.heater.html">control.lib.heater</a></li>
            
                <li><a href="../classes/control.lib.heater.pin.html">control.lib.heater.pin</a></li>
            
                <li><a href="../classes/control.lib.heater.tariff.html">control.lib.heater.tariff</a></li>
            
                <li><a href="../classes/control.lib.light.html">control.lib.light</a></li>
            
                <li><a href="../classes/control.lib.light.pin.html">control.lib.light.pin</a></li>
            
                <li><a href="../classes/control.lib.light.remote.html">control.lib.light.remote</a></li>
            
                <li><a href="../classes/control.lib.light.switch.html">control.lib.light.switch</a></li>
            
                <li><a href="../classes/control.lib.pin.html">control.lib.pin</a></li>
            
                <li><a href="../classes/control.lib.pin.commands.html">control.lib.pin.commands</a></li>
            
                <li><a href="../classes/control.lib.pin.counter.html">control.lib.pin.counter</a></li>
            
                <li><a href="../classes/control.lib.pin.din.html">control.lib.pin.din</a></li>
            
                <li><a href="../classes/control.lib.pin.dout.html">control.lib.pin.dout</a></li>
            
                <li><a href="../classes/control.lib.pin.light.html">control.lib.pin.light</a></li>
            
                <li><a href="../classes/control.lib.pin.list.html">control.lib.pin.list</a></li>
            
                <li><a href="../classes/control.lib.pin.pwm.html">control.lib.pin.pwm</a></li>
            
                <li><a href="../classes/control.lib.pin.switch.html">control.lib.pin.switch</a></li>
            
                <li><a href="../classes/control.lib.remote.html">control.lib.remote</a></li>
            
                <li><a href="../classes/control.lib.room.html">control.lib.room</a></li>
            
                <li><a href="../classes/control.lib.switch.html">control.lib.switch</a></li>
            
                <li><a href="../classes/control.lib.switch.relay.html">control.lib.switch.relay</a></li>
            
                <li><a href="../classes/control.lib.switch.socket.html">control.lib.switch.socket</a></li>
            
                <li><a href="../classes/dvb.content.html">dvb.content</a></li>
            
                <li><a href="../classes/dvb.lib.html">dvb.lib</a></li>
            
                <li><a href="../classes/dvb.lib.channel.html">dvb.lib.channel</a></li>
            
                <li><a href="../classes/fs.content.html">fs.content</a></li>
            
                <li><a href="../classes/fs.lib.html">fs.lib</a></li>
            
                <li><a href="../classes/fs.lib.dir.html">fs.lib.dir</a></li>
            
                <li><a href="../classes/fs.lib.file.html">fs.lib.file</a></li>
            
                <li><a href="../classes/icecast.content.html">icecast.content</a></li>
            
                <li><a href="../classes/icecast.lib.html">icecast.lib</a></li>
            
                <li><a href="../classes/icecast.lib.stream.html">icecast.lib.stream</a></li>
            
                <li><a href="../classes/lirc.content.html">lirc.content</a></li>
            
                <li><a href="../classes/lirc.lib.html">lirc.lib</a></li>
            
                <li><a href="../classes/lirc.lib.lirc.html">lirc.lib.lirc</a></li>
            
                <li><a href="../classes/media.content.html">media.content</a></li>
            
                <li><a href="../classes/media.lib.html">media.lib</a></li>
            
                <li><a href="../classes/media.lib.item.html">media.lib.item</a></li>
            
                <li><a href="../classes/media.lib.player.html">media.lib.player</a></li>
            
                <li><a href="../classes/media.lib.player.commands.html">media.lib.player.commands</a></li>
            
                <li><a href="../classes/media.lib.player.dvb.html">media.lib.player.dvb</a></li>
            
                <li><a href="../classes/media.lib.player.playback.html">media.lib.player.playback</a></li>
            
                <li><a href="../classes/media.lib.player.remote.html">media.lib.player.remote</a></li>
            
                <li><a href="../classes/media.lib.player.volume.html">media.lib.player.volume</a></li>
            
                <li><a href="../classes/media.lib.sources.html">media.lib.sources</a></li>
            
                <li><a href="../classes/media.lib.stream.html">media.lib.stream</a></li>
            
                <li><a href="../classes/ose.content.html">ose.content</a></li>
            
                <li><a href="../classes/ose.core.html">ose.core</a></li>
            
                <li><a href="../classes/ose.lib.browser.html">ose.lib.browser</a></li>
            
                <li><a href="../classes/ose.lib.cli.html">ose.lib.cli</a></li>
            
                <li><a href="../classes/ose.lib.counter.html">ose.lib.counter</a></li>
            
                <li><a href="../classes/ose.lib.entry.html">ose.lib.entry</a></li>
            
                <li><a href="../classes/ose.lib.entry.link.html">ose.lib.entry.link</a></li>
            
                <li><a href="../classes/ose.lib.entry.master.html">ose.lib.entry.master</a></li>
            
                <li><a href="../classes/ose.lib.entry.slave.html">ose.lib.entry.slave</a></li>
            
                <li><a href="../classes/ose.lib.http.html">ose.lib.http</a></li>
            
                <li><a href="../classes/ose.lib.http.content.html">ose.lib.http.content</a></li>
            
                <li><a href="../classes/ose.lib.kind.html">ose.lib.kind</a></li>
            
                <li><a href="../classes/ose.lib.link.html">ose.lib.link</a></li>
            
                <li><a href="../classes/ose.lib.logger.html">ose.lib.logger</a></li>
            
                <li><a href="../classes/ose.lib.node.html">ose.lib.node</a></li>
            
                <li><a href="../classes/ose.lib.peer.here.html">ose.lib.peer.here</a></li>
            
                <li><a href="../classes/ose.lib.peer.list.html">ose.lib.peer.list</a></li>
            
                <li><a href="../classes/ose.lib.peer.remote.html">ose.lib.peer.remote</a></li>
            
                <li><a href="../classes/ose.lib.peer.rx.html">ose.lib.peer.rx</a></li>
            
                <li><a href="../classes/ose.lib.plugins.html">ose.lib.plugins</a></li>
            
                <li><a href="../classes/ose.lib.scope.html">ose.lib.scope</a></li>
            
                <li><a href="../classes/ose.lib.shard.html">ose.lib.shard</a></li>
            
                <li><a href="../classes/ose.lib.shard.master.html">ose.lib.shard.master</a></li>
            
                <li><a href="../classes/ose.lib.shard.slave.html">ose.lib.shard.slave</a></li>
            
                <li><a href="../classes/ose.lib.space.html">ose.lib.space</a></li>
            
                <li><a href="../classes/ose.lib.space.list.html">ose.lib.space.list</a></li>
            
                <li><a href="../classes/ose.lib.ws.html">ose.lib.ws</a></li>
            
                <li><a href="../classes/ose.lib.ws.browser.html">ose.lib.ws.browser</a></li>
            
                <li><a href="../classes/ose.lib.ws.master.html">ose.lib.ws.master</a></li>
            
                <li><a href="../classes/ose.lib.ws.node.html">ose.lib.ws.node</a></li>
            
                <li><a href="../classes/ose.lib.ws.relay.html">ose.lib.ws.relay</a></li>
            
                <li><a href="../classes/ose.lib.ws.slave.html">ose.lib.ws.slave</a></li>
            
                <li><a href="../classes/ose.wrap.class.html">ose.wrap.class</a></li>
            
                <li><a href="../classes/ose.wrap.common.html">ose.wrap.common</a></li>
            
                <li><a href="../classes/ose.wrap.module.html">ose.wrap.module</a></li>
            
                <li><a href="../classes/ose.wrap.package.html">ose.wrap.package</a></li>
            
                <li><a href="../classes/ose.wrap.singleton.html">ose.wrap.singleton</a></li>
            
                <li><a href="../classes/pa.content.html">pa.content</a></li>
            
                <li><a href="../classes/pa.lib.html">pa.lib</a></li>
            
                <li><a href="../classes/pa.lib.dbus.html">pa.lib.dbus</a></li>
            
                <li><a href="../classes/rpi.content.html">rpi.content</a></li>
            
                <li><a href="../classes/rpi.lib.html">rpi.lib</a></li>
            
                <li><a href="../classes/rpi.lib.camera.html">rpi.lib.camera</a></li>
            
                <li><a href="../classes/rpi.lib.rpi.html">rpi.lib.rpi</a></li>
            
                <li><a href="../classes/videolan.content.html">videolan.content</a></li>
            
                <li><a href="../classes/videolan.lib.html">videolan.lib</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.html">videolan.lib.dvblast</a></li>
            
                <li><a href="../classes/videolan.lib.dvblast.master.html">videolan.lib.dvblast.master</a></li>
            
                <li><a href="../classes/videolan.lib.vlc.html">videolan.lib.vlc</a></li>
            
                <li><a href="../classes/xorg.content.html">xorg.content</a></li>
            
                <li><a href="../classes/xorg.lib.html">xorg.lib</a></li>
            
                <li><a href="../classes/xorg.lib.xorg.html">xorg.lib.xorg</a></li>
            
                <li><a href="../classes/yoctopuce.content.html">yoctopuce.content</a></li>
            
                <li><a href="../classes/yoctopuce.lib.html">yoctopuce.lib</a></li>
            
                <li><a href="../classes/yoctopuce.lib.meteo.html">yoctopuce.lib.meteo</a></li>
            
                <li><a href="../classes/youtube.content.html">youtube.content</a></li>
            
                <li><a href="../classes/youtube.lib.html">youtube.lib</a></li>
            
                <li><a href="../classes/youtube.lib.video.html">youtube.lib.video</a></li>
            
        </ul>
    </div>
</div>


      </div>

      <div id="main" class="yui3-u">
        <div class="content"><h4>../videolan/lib/vlc/home.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var Ose = require(&#x27;ose&#x27;);
var M = Ose.module(module);

var Process = require(&#x27;child_process&#x27;);
var Dbus = require(&#x27;ndbus&#x27;);

/** Docs {{{1
 * @module videolan
 */

/**
 * @class videolan.lib.vlc
 */

// Public {{{1
module.exports = function(entry) {  // {{{2
  if (! (this.commands &amp;&amp; (&#x27;play&#x27; in this.commands))) {
    entry.kind.on({
      play: play,
      playUri: playUri,
      pause: pause,
      stop: stop,
      turnOff: turnOff,
      fullscreen: fullscreen,
      raise: raise,
      shuffle: shuffle,
      seek: seek,
      next: next,
      previous: previous,
    });
  }

  entry.queueStateTimeout = 0;

  entry.on(&#x27;remove&#x27;, onRemove.bind(entry));

  if (VlcVersion) {
    doIt();
  } else {
    getVersion(doIt);
  }

  function doIt(err, version) {
    if (err) {
      M.log.error(entry, err);
      return;
    }

    if (version) {
      VlcVersion = version;
    }

    getObject(entry, function(err) {
      if (err) {
        M.log.error(err);
        return;
      }

      getStatus(entry);
      getShuffle(entry);
      getMetadata(entry);
      return;
    });
  }
};

// }}}1
// Command handlers {{{1
function playUri(req) {  // {{{2
/**
 * [Command handler]
 *
 * Play media from URI.
 *
 * @param req {String} Media URI
 *
 * @method playUri
 */

//  console.log(&#x27;VLC PLAY URI&#x27;);

  getObject(this.entry, openUri.bind(null, this.entry, req));
};

function play(req) {  // {{{2
/**
 * [Command handler]
 *
 * Play
 *
 * @method play
 */

  this.entry.object.Play();
};

function pause(req) {  // {{{2
/**
 * [Command handler]
 *
 * Pause playback
 *
 * @method pause
 */

  this.entry.object.Pause();
};

function stop(req) {  // {{{2
/**
 * [Command handler]
 *
 * Stop playback
 *
 * @method stop
 */

//  console.log(&#x27;VLC STOP&#x27;, req);

  this.entry.object.Stop();
};

function turnOff(req) {  // {{{2
/**
 * [Command handler]
 *
 * Turns the player off.
 *
 * @param req None
 *
 * @method turnOff
 */

  quit(this.entry);
};

function fullscreen(req) {  // {{{2
/**
 * [Command handler]
 *
 * Switch fullscreen
 *
 * @param req {Object} Fullscreen? TODO
 *
 * @method fullscreen
 */

  M.log.missing(&#x27;notImplemented&#x27;);
};

function raise(req) {   // {{{2
/**
 * [Command handler]
 *
 * Raise window
 *
 * @method fullscreen
 */

  this.entry.core.Raise();
};

function shuffle(req) {  // {{{2
/**
 * [Command handler]
 *
 * Switch shuffle
 *
 * @param req {Boolean} Shuffle?
 *
 * @method shuffle
 */

  if (this.entry.props) {
    this.entry.props.Set(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;Shuffle&#x27;, req);
  }

  this.entry.setState({shuffle: req});
};

function seek(req) {  // {{{2
/**
 * [Command handler]
 *
 * Seek media
 *
 * @param req {Number} Position in microseconds
 *
 * @method seek
 */

  this.entry.object.Seek(req);
  getPos(this.entry);
};

function next(req) {  // {{{2
/**
 * [Command handler]
 *
 * Skip to next media
 *
 * @param req {Object} Request object TODO
 *
 * @method next
 */

  this.entry.clearInfo = true;
  this.entry.object.Next();
};

function previous(req) {  // {{{2
/**
 * [Command handler]
 *
 * Skip to previous media
 *
 * @param req {Object} Request object TODO
 *
 * @method previous
 */

  this.entry.clearInfo = true;
  this.entry.object.Previous();
};

// }}}1
// Event Handlers {{{1
function onRemove(data) {  // {{{2
  quit(this);
}

function onCanPause(err, result) {  // {{{2
  this.setState({can: {pause: result === 1}});
}

function onCanSeek(err, result) {  // {{{2
  this.setState({can: {seek: result === 1}});
}

function onCanGoPrevious(err, result) {  // {{{2
  this.setState({can: {goPrevious: result === 1}});
}

function onCanGoNext(err, result) {  // {{{2
  this.setState({can: {goNext: result === 1}});
}

function onCanSetFullscreen(err, result) {  // {{{2
  this.setState({can: {setFullscreen: result === 1}});
}

function propertyChanged(iface, props) {  // {{{2
  for (var key in props) {
    var value = props[key];

    switch (key) {
    case &#x27;CanPause&#x27;:
      this.setState({can: {pause: Boolean(value)}});
      break;
    case &#x27;CanGoPrevious&#x27;:
      this.setState({can: {prev: Boolean(value)}});
      break;
    case &#x27;CanGoNext&#x27;:
      this.setState({can: {next: Boolean(value)}});
      break;
    case &#x27;CanSeek&#x27;:
      this.setState({can: {seek: Boolean(value)}});
      break;
    case &#x27;CanPlay&#x27;:
      this.setState({can: {play: Boolean(value)}});
      break;
    case &#x27;Shuffle&#x27;:
      this.setState({shuffle: Boolean(value)});
      break;
    case &#x27;PlaybackStatus&#x27;:
      readStatus(this, value);
      break;
    case &#x27;Metadata&#x27;:
      readMetadata(this, value);
      break;
    case &#x27;Rate&#x27;:
    case &#x27;Volume&#x27;:
      break; // TODO
    default:
      M.log.unhandled(&#x27;Unexpected property change.&#x27;, {key: key, value: value});
    }
  }
}

// }}}1
// Private {{{
var VlcVersion = &#x27;&#x27;;
var MatchVlc = /^\s*(\d+)\s.+\s.+\s.+\s+vlc\s.+--control=dbus/;

function readMetadata(that, data) {  // {{{2
//  console.log(&#x27;READ META&#x27;, data);

  if (that.clearInfo) {
    delete that.clearInfo;
    that.setState({info: null});
  }

  for (var key in data) {
    var value = removeArray(data[key]);

    switch (key) {
    case &#x27;status&#x27;:
    case &#x27;language&#x27;:
    case &#x27;mpris:artUrl&#x27;:
    case &#x27;mpris:trackid&#x27;:
    case &#x27;vlc:publisher&#x27;:
    case &#x27;vlc:encodedby&#x27;:
    case &#x27;vlc:copyright&#x27;:
    case &#x27;xesam:genre&#x27;:
    case &#x27;xesam:contentCreated&#x27;:
    case &#x27;xesam:tracknumber&#x27;:
    case &#x27;xesam:album&#x27;:
      break;
    case &#x27;xesam:url&#x27;:
      that.setState({info: {url: value}});
      break;
    case &#x27;xesam:comment&#x27;:
      that.setState({info: {comment: value}});
      break;
    case &#x27;xesam:artist&#x27;:
      that.setState({info: {artist: value}});
      break;
    case &#x27;xesam:title&#x27;:
      that.setState({info: {title: value}});
      break;
    case &#x27;vlc:nowplaying&#x27;:
      that.setState({info: {nowPlaying: value}});
      break;
    case &#x27;mpris:length&#x27;:
      //        console.log(&#x27;MPRIS LENGTH&#x27;, value);

      if (value &lt;= 0) {
        that.setState({pos: null});
      } else {
        that.setState({pos: {length: value / 1000000}});
        getPos(that);
      }
      break;
    case &#x27;vlc:length&#x27;:
      //        console.log(&#x27;VLC LENGTH&#x27;, value);
      //        that.setState({pos: {length: value / 1000}});
      break;
    case &#x27;vlc:time&#x27;:
      //        console.log(&#x27;VLC TIME&#x27;, value);
      //        that.setState({pos: {length: value}});
      getPos(that);
      break;
    default:
      M.log.unhandled(&#x27;Metadata&#x27;, {key: key, value: value});
    }
  }
};

function openUri(that, uri) {  // {{{2
//  console.log(&#x27;VLC OPEN URI&#x27;, uri);

  if (typeof uri !== &#x27;string&#x27;) {
    M.log.unhandled(&#x27;Invalid uri&#x27;, uri);
  } else {
    that.object &amp;&amp; that.object.OpenUri(uri, function(err) {
//      console.log(&#x27;VLC OPEN URI RESPONSE&#x27;, arguments);
      if (err) {
        M.log.error(err);
      }
    });
  }
};

function getObject(that, params, cb) {  // {{{2
//  console.log(&#x27;VLC GET OBJECT&#x27;);

  var counter;

  if (! cb) {  // We can pass only callback without params to this function.
    cb = params;
    params = {};
  }

  if (that.object) {
    cb();
    return;
  }

  if (! VlcVersion) {
    cb(Ose.error(&#x27;VLC_VERSION_NOT_RECOGNIZED&#x27;));
    return;
  }

  return Process.exec(&#x27;ps -x&#x27;, onPs);

  function onPs(err, stdout, stderr) {  // {{{3
    if (err) throw new Error(err);

    readPs(stdout.split(&#x27;\n&#x27;));
  }

  function readPs(stdout) {  // {{{3
    for (var i = 0; i &lt; stdout.length; i++) {
      var match = stdout[i].match(MatchVlc);

      if (match) return connectVlc(match[1]);
    }

    if (! (params &amp;&amp; params.noStart)) {
      return runVlc();
    }

    cb();
    return;
  }

  function runVlc() {  // {{{3
    Process.exec(&#x27;killall vlc&#x27;, doRun);
  };

  function doRun() {  // {{{3
    var args = [
      &#x27;-I&#x27;, &#x27;dummy&#x27;,
      &#x27;--fullscreen&#x27;,
      &#x27;--no-auto-preparse&#x27;,
      &#x27;--control=dbus&#x27;,
    ];

    if (that.state.shuffle) {
      args.push(&#x27;--random&#x27;);
    }

    /*
    if (params.dvb) {
      args.push(&#x27;dvb://frequency=&#x27; + params.dvb.freq + &#x27;:bandwidth=&#x27; + params.dvb.bandwidth + &#x27;:adapter=0&#x27;);
      args.push(&#x27;:live-caching=300&#x27;);
      args.push(&#x27;:program=&#x27; + params.dvb.number);
    }
    */

    var handle = Process.spawn(&#x27;vlc&#x27;, args);
    handle.stderr.setEncoding(&#x27;utf8&#x27;);
    handle.stderr.on(&#x27;data&#x27;, onStderr);

    function onStderr(data) {  // {{{
      if (data.indexOf(&#x27;using the dummy interface module...&#x27;) &gt;= 0) {
//      if (data.indexOf(&#x27;Running vlc with the default interface&#x27;) &gt;= 0) {
        handle.stderr.removeAllListeners(&#x27;data&#x27;);
        connectVlc(handle.pid);
      } else {
        console.log(&#x27;VLC STDERR&#x27;, that.id, data);
      }
    }

    // }}}
  }

  function connectVlc(pid) {  // {{{3
    if (that.pid) {
      quit(that);
    }

    that.pid = pid;

    counter = Ose.counter(done);
    counter.inc();
    counter.inc();

    var bus = Dbus();

    // TODO Test in different distributions
    if (VlcVersion &gt;= 2.2) {
      var name = &#x27;org.mpris.MediaPlayer2.vlc&#x27;;
    } else if (VlcVersion &gt;= 2.1) {
      var name = &#x27;org.mpris.MediaPlayer2.vlc.instance&#x27; + pid;
    } else {
      var name = &#x27;org.mpris.MediaPlayer2.vlc&#x27; + &#x27;-&#x27; + pid;
    } 

    bus.proxy(name, &#x27;/org/mpris/MediaPlayer2&#x27;, &#x27;org.mpris.MediaPlayer2&#x27;, onCore);
    bus.proxy(name, &#x27;/org/mpris/MediaPlayer2&#x27;, &#x27;org.mpris.MediaPlayer2.Player&#x27;, onPlayer);
    bus.proxy(name, &#x27;/org/mpris/MediaPlayer2&#x27;, &#x27;org.freedesktop.DBus.Properties&#x27;, onProps);
  };

  function onCore(err, object) {  // {{{3
    if (err) {
      M.log.error(err);
      quit(that);
    } else {
      that.core = object;
    }

    counter.dec();
  };

  function onPlayer(err, object) {  // {{{3
    if (err) {
      M.log.error(err);
      quit(that);
    } else {
      that.object = object;
    }

    counter.dec();
  };

  function onProps(err, object) {  // {{{3
    if (err) {
      M.log.error(err);
      quit(that);
    } else {
      that.props = object;
      object.PropertiesChanged.on(propertyChanged.bind(that));
      object.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;CanPause&#x27;, onCanPause.bind(that));
      object.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;CanSeek&#x27;, onCanSeek.bind(that));

      // Optional mpris props not currently supported by VLC:
      object.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;CanGoPrevious&#x27;, onCanGoPrevious.bind(that));
      object.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;CanGoNext&#x27;, onCanGoNext.bind(that));
      object.Get(&#x27;org.mpris.MediaPlayer2&#x27;, &#x27;CanSetFullScreen&#x27;, onCanSetFullscreen.bind(that));
    }

    counter.dec();
  };

  function done(err) {  // {{{3
//    console.log(&#x27;DONE&#x27;, that.id);

    if (that.removed) quit(that);

    cb();
  };

  // }}}
};

function quit(that) {   // {{{2
//  console.log(&#x27;QUITTING&#x27;, that.id);

  that.entry.object &amp;&amp; that.entry.object.Stop();

  /*
  if (that.props) {
    that.props.PropertiesChanged.off();
    that.props.$();
    delete that.props;
  }

  if (that.object) {
    that.object.$();
    delete that.object;
  }

  if (that.core) {
    that.core.Quit();
    that.core.$();
    delete that.core;
  }

  if (that.pid) {
    try {
      process.kill(that.pid, &#x27;SIGKILL&#x27;);
    } catch (err) {
      M.log.handleCatch(err)
    }
    delete that.pid;
  }

  that.setState({
    status: &#x27;stopped&#x27;,
    pos: null,
    can: null,
    info: null,
  });
  */
}

function getMetadata(that) {   // {{{2
  that.props.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;Metadata&#x27;, function(err, value) {
    if (err) {
      M.log.unhandled(err);
    } else {
      readMetadata(that, value);
    }
  });
};

function getPos(that) {   // {{{2
  that.props.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;Position&#x27;, function(err, pos) {
    if (err) {
      M.log.unhandled(err);
    } else {
      that.setState({pos: {
        value: pos / 1000000,
        at: new Date().getTime()
      }});
    }
  });
};

function getShuffle(that) {   // {{{2
  that.props.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;Shuffle&#x27;, function(err, value) {
    if (err) {
      M.log.unhandled(err);
    } else {
      that.setState({shuffle: Boolean(value)});
    }
  });
};

function getStatus(that) {   // {{{2
  that.props.Get(&#x27;org.mpris.MediaPlayer2.Player&#x27;, &#x27;PlaybackStatus&#x27;, function(err, resp) {
    if (err) {
      M.log.unhandled(err);
    } else {
      readStatus(that, resp);
    }
  });
};

function readStatus(that, value) {  // {{{2
  switch (value) {
  case &#x27;Playing&#x27;:
    that.setState({status: &#x27;playing&#x27;});
    getPos(that);

    break;
  case &#x27;Paused&#x27;:
    that.setState({status: &#x27;paused&#x27;});
    getPos(that);

    break;
  case &#x27;Stopped&#x27;:
    that.setState({
      status: &#x27;stopped&#x27;,
      pos: null,
      info: null,
    });
    break;
  default:
    M.log.unhandled(&#x27;Unexpected playback status.&#x27;, value);
  }
}

function removeArray(value) {  // {{{2
  if (Array.isArray(value)) {
    switch (value.length) {
    case 0:
      return null;
    case 1:
      value = value[0];
      break;
    default:
      M.log.unhandled(&#x27;Expected array length is 1&#x27;, value);
      value = value[0];
      break;
    }
  }

  switch (typeof value) {
  case &#x27;string&#x27;:
    value = value.trim();
    if (! value) {
      return null;
    }

    break;
  }

  return value;
};

function getVersion(cb) {  // {{{2
  Process.exec(&#x27;vlc --version&#x27;, function(err, stdout, stderr) {
    if (err) {
      cb(err);
      return;
    }

    var data = stdout.split(&#x27;\n&#x27;);

    for (var i = 0; i &lt; data.length; i++) {
      if (! data[i]) continue;

      var match = data[i].match(/VLC version (\d+\.\d+)/);

      if (match) {
        try {
          var data = parseFloat(match[1]);
        } catch (err) {
          cb(err);
          return;
        }

        cb(null, data);
        return;
      }
    }

    cb(Ose.error(&#x27;VLC_VERSION_NOT_RECOGNIZED&#x27;, stdout));
    return;
  });
};

// }}}1

</pre>

</div>
      </div>

    </div>
  </div>
  <script src="../assets/vendor/prettify/prettify-min.js"></script>
  <script>prettyPrint();</script>
  <script src="../assets/js/yui-prettify.js"></script>
  <script src="../assets/js/ose.js"></script>
</body>
</html>
